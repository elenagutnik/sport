{% extends "base.html" %}
{% import "_user.html" as macros %}

{% block title %} Получатель{% endblock %}

{% block page_content %}

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.6/socket.io.min.js"></script>
<script type="text/javascript" charset="utf-8">

    var socket = io.connect('http://127.0.0.1:5000');
    socket.on('connect', function() {
        socket.emit('my event', {data: 'I\'m connected!'});
    });
    var finish_res= new Array();
    socket.on('newData', function(data) {

      var i;
      var data_arr=JSON.parse(data);
      var list = new Array(data_arr.length);
      var course = new Array(data_arr.length);
      var sector = new Array(data_arr.length);
      var lastcomp=new Array(data_arr[data_arr.length-1].length);

      lastcomp=data_arr[data_arr.length-1];

      if(data_arr.length<=1 && lastcomp[4].name=="Start"){
        console.log("data_arr.length=",data_arr.length);
        console.log("lastcomp[4].name=",lastcomp[4].name);
        // на всякий случай очищаем массив finish_res
        finish_res.length = 0;
        //finiss_res=
      }
      console.log("finish_res.length="+finish_res.length);
      for (i = 0; i < data_arr.length; i++) {
        list[i]=[i, data_arr[i][1].bib, data_arr[i][0].time, data_arr[i][0].sectortime];
        course[i]=[i, data_arr[i][1].bib, data_arr[i][0].time, data_arr[i][0].sectortime];
        sector[i]=[i, data_arr[i][1].bib, data_arr[i][0].time, data_arr[i][0].sectortime];
      }

      console.log("data_arr="+data_arr);

      //сортируем результаты спортсменов по всей трассе (от старта до текущего девайса)
      function sort_course(a, b) {
          if (a[2] > b[2]) return 1; else if (a[2] < b[2]) return -1; else return 0;
      }

      course.sort(sort_course);
      for(i=0;i<course.length;i++){
         data_arr[course[i][0]][0].rank=i+1;
         data_arr[i][0].diff=data_arr[i][0].time-course[0][2];
      }
//      console.log('course');
//      console.log(course);

      //сортируем результаты спортсменов по текущему сектору
      function sort_sector(a, b) {
          return a[3] == b[3] ? a > b : a[3] > b[3]
      }

      sector.sort(sort_sector);
      for(i=0;i<sector.length;i++){
        data_arr[sector[i][0]][0].sectorrank=i+1;
        data_arr[i][0].sectordiff=data_arr[i][0].sectortime-sector[0][3];
      }
//      console.log('sector');
//      console.log(sector);
      $("#compname").html(lastcomp[2].en_lastname+" "+lastcomp[2].en_firstname);
      $("#compbib").html(lastcomp[1].bib);

      if(lastcomp[4].name=="Start"){
        $("#compname").html(lastcomp[2].en_lastname+" "+lastcomp[2].en_firstname);
        $("#compbib").html(lastcomp[1].bib);
        $("#tabcomp").html('');
        $("#tabfinish").append("<tr id='fintr"+lastcomp[1].bib+"'><td>"+data_arr.length+"</td><td class='rank'>-</td><td class='time'>"+lastcomp[0].time+"</td><td class='diff'>-</td><td>"+lastcomp[1].bib+"</td><td>"+ lastcomp[2].en_lastname+" "+lastcomp[2].en_firstname+"</td><td class='status'>Started</td><td class='action'><button value=''>edit</button></td></tr>");
      }else{
        if (lastcomp[4].name=="Finish") {
          finish_res.push([lastcomp[1].bib,lastcomp[2].en_firstname, lastcomp[2].en_lastname,lastcomp[0].time]);
          console.log("finish_res=");
          console.log(finish_res);
          console.log("lastcomp=");
          console.log(lastcomp);
          //finish_res.sort(sort_sector);
          /*var finish_res_sort=finish_res;
          finish_res_sort.sort(sort_sector);
          for(i=0;i<finish_res_sort.length;i++){
            $("#fintr"+finish_res_sort[i][0]+" .rank").html(i+1);
            $("#fintr"+finish_res_sort[i][0]+" .diff").html(finish_res_sort[i][3]-finish_res_sort[0][3]);
          }
          */
          for(i=0;i<course.length;i++){
            $("#fintr"+course[i][1]+" .rank").html(i+1);
            $("#fintr"+course[i][1]+" .diff").html(data_arr[course[i][0]][0].diff);

          }
        //  console.log(course);
        //  $("#fintr"+lastcomp[1].bib+" .rank").html()
          $("#fintr"+lastcomp[1].bib+" .status").html("finished");
          $("#fintr"+lastcomp[1].bib+" .action").append("<button class='approveQLF' absolut_time='"+lastcomp[0].absolut_time+"' competitor_id='"+lastcomp[1].id+"' run_id='"+lastcomp[1].run_id+"'>Approve QLF</button>");
          $("#fintr"+lastcomp[1].bib+" .time").html(lastcomp[0].time);

      //    $("#fintr"+lastcomp[1].bib).html("<td class='rank'>"+lastcomp[0].rank+"</td><td>"+lastcomp[0].time+"</td><td class='diff'>"+lastcomp[0].diff+"</td><td>"+lastcomp[1].bib+"</td><td>"+ lastcomp[2].en_lastname+" "+lastcomp[2].en_firstname+"</td><td>Finished</td>");
        }else{
          $("#fintr"+lastcomp[1].bib+" .time").html(lastcomp[0].time);
          $("#fintr"+lastcomp[1].bib+" .status").html("In progress");
        }
      }
      $("#tabcomp").append("<tr><td>"+lastcomp[4].name+" - "+lastcomp[3].distance+"m (#"+lastcomp[3].device_id+")</td><td>"+lastcomp[0].speed+"</td><td>"+lastcomp[0].rank+"</td><td>"+lastcomp[0].diff+"</td><td>"+lastcomp[0].time+"</td><td>"+lastcomp[0].sectorrank+"</td><td>"+lastcomp[0].sectordiff+"</td><td>"+lastcomp[0].sectortime+"</td></tr>");
      $("#tabsector").html('');
      //$("#tabsector").append('<tr><td colspan="5">DEVICE: '+lastcomp[3].distance+"m (#"+lastcomp[3].device_id+'</td></tr>');
      for(i=0;i<sector.length;i++){
//        console.log('i='+i);
//        console.log('sector[i]='+sector[i]);
          $("#tabsector").append("<tr><td>"+data_arr[sector[i][0]][0].sectorrank+"</td><td>"+data_arr[sector[i][0]][0].sectortime+"</td><td>"+data_arr[sector[i][0]][0].sectordiff+"</td><td>"+data_arr[sector[i][0]][1].bib+"</td><td>"+ data_arr[sector[i][0]][2].en_lastname+" "+data_arr[sector[i][0]][2].en_firstname+"</td></tr>");
      }
      $("#tabcourse").html('');
      for(i=0;i<course.length;i++){
        $("#tabcourse").append("<tr><td>"+data_arr[course[i][0]][0].rank+"</td><td>"+data_arr[course[i][0]][0].time+"</td><td>"+data_arr[course[i][0]][0].diff+"</td><td>"+data_arr[course[i][0]][1].bib+"</td><td>"+ data_arr[course[i][0]][2].en_lastname+" "+data_arr[course[i][0]][2].en_firstname+"</td></tr>");
      }

      //$("#tab").append(list+"<br>");
    });
</script>
<script type="text/javascript">

</script>
<div>
  <h1>Runs / Current run <span id="run_current"></span></h1>
  <table style="width:100%;" class="table table-bordered">
    <thead>
      <tr>
        <th>№</th>
        <th>Start time</th>
        <th>End time</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="run_list">
    </tbody>
  </table>
  <h2>Competitor data</h2>
  <b>
    NAME: <span id="compname">-</span>
    <br>
    BIB: <span id="compbib">-</span>
    <br><br>
  </b>
  <table style="width:100%;" class="table table-bordered">
    <thead>
      <tr>
        <th>Device</th>
        <th>Speed</th>

        <th>Rank</th>
        <th>Diff</th>
        <th>Time</th>

        <th>Sector Rank</th>
        <th>Sector Diff</th>
        <th>Sector Time</th>
      </tr>
    </thead>
    <tbody id="tabcomp">
    </tbody>
  </table>
</div>

<div>
  <h2>Sector data (for current dev)</h2>
  <table style="width:100%;" class="table table-bordered">
    <thead>
      <tr>
        <th>Rank</th>
        <th>Time</th>
        <th>Diff</th>
        <th>Bib</th>
        <th>Name</th>
      </tr>
    </thead>
    <tbody id="tabsector">
    </tbody>
  </table>
</div>

<div>
  <h2>Course data (for current dev)</h2>
  <table style="width:100%;" class="table table-bordered">
    <thead>
      <tr>
        <th>Rank</th>
        <th>Time</th>
        <th>Diff</th>
        <th>Bib</th>
        <th>Name</th>
      </tr>
    </thead>
    <tbody id="tabcourse">
    </tbody>
  </table>
</div>

<div>
  <h2>Finish data</h2>
  <table style="width:100%;" class="table table-bordered">
    <thead>
      <tr>
        <th>№</th>
        <th>Rank</th>
        <th>Time</th>
        <th>Diff</th>
        <th>Bib</th>
        <th>Name</th>
        <th>Status</th>
        <th>Aprove</th>
      </tr>
    </thead>
    <tbody id="tabfinish">
    </tbody>
  </table>
</div>

<div>
  <h2>Summary tab</h2>
  <table style="width:100%;" class="table table-bordered" id="tabsummary">
    <thead>
      <tr>
        <th>bib/dev</th>
        <th>Start</th>
        <th></th>
        <th></th>
        <th></th>
        <th></th>
        <th>Finish</th>
      </tr>
    </thead>
    <tbody>
    </tbody>
  </table>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script type="text/javascript">
var huy='';

var race_id=1; // пока задаем вручную
var run={'id':null,'number':null}; // активный заезд
var run_list=new Array(); // список всех заездов для race_id

$(document).ready(function () {
  // подтверждение заезда спортсмена со статусом QLF
  $("body").on("click", ".approveQLF", function () {
    console.log($(this).attr('competitor_id'));
    console.log($(this).attr('run_id'));
    console.log($(this).attr('absolut_time'));

      $.ajax({
        url: "/raceinfo/approve/run/"+$(this).attr('run_id')+"/competitor/"+$(this).attr('competitor_id'),
        dataType: 'json',
        data: {
          data: JSON.stringify({
            'absolut_time':$(this).attr('absolut_time')}
          )},
          success:function(data) {alert(data);},
          error: function (error) {alert('ХУЙ'); }
      });

  });

  runinfo_get();

  // получение и вывод на странице инфы о всех заездах (race_id - задан глобально)
  function runinfo_get(){
    $.ajax({
      type: "GET",
      url: "/raceinfo/run/get/",
      data: {
        'race_id': race_id
        }
    })
      .done(function(data) {
        if ( console && console.log ) {
          var btn='';
          $("#run_list").html(''); // очищаем таблицу
          run_list = JSON.parse(data);
          run_list.sort(function(a,b){return a['number'] == b['number'] ? a > b : a['number'] > b['number']}); // сортируем заезды по порядку number
          run={'id':null,'number':'-'};
          for(var i=0; i<run_list.length; i++){ // заполняем таблицу #run_list
            btn=''; // код кнопки старта/финиша заезда
            if(run_list[i]['endtime']) //заезд завершен - ничего
              btn='';
            else if(run_list[i]['starttime']){ //заезд начат - завершить заезд
              btn='<button class="run_finish" run_id="'+run_list[i]['id']+'">Finish</button>';
              run={'id':run_list[i]['id'],'number':run_list[i]['number']}; // данные активного(текущего) заезда
            }else if(!run.id){ // заезд не начат - начать заезд
              btn='<button class="run_start" run_id="'+run_list[i]['id']+'">Start</button>';
            }
            $("#run_list").append('<tr><td>'+run_list[i]['number']+'</td><td>'+run_list[i]['starttime']+'</td><td>'+run_list[i]['endtime']+'</td><td>'+btn+'</td></tr>');
          }
          $("#run_current").html(run.number);
        }
      });
  }

  // обработка кнопки финиш заезда
  $("body").on("click", ".run_finish", function () {
    $.ajax({
      type: "GET",
      url: "/raceinfo/race/"+race_id+"/run/"+$(this).attr('run_id')+"/stop",
    })
      .done(function(data) {
        runinfo_get();
      });
  });

  // обработка кнопки старт заезда
  $("body").on("click", ".run_start", function () {
    $.ajax({
      type: "GET",
      url: "/raceinfo/race/"+race_id+"/run/"+$(this).attr('run_id')+"/start",
    })
      .done(function(data) {
        runinfo_get();
      });
  });
});
</script>
{% endblock %}
