<html>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.6/jquery.min.js"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/moment.js/2.3.1/moment-with-langs.min.js"></script>
</html>
<script>
var startlist=["1","2","3","4","5","6"]; //стартовый список
var gap=30; // gap between competitors starts

var race =  JSON.parse('{{ race | safe }}');

var courses = JSON.parse('{"4": [[{"course_device_type_id": 1, "course_id": 4, "device_id": 1, "distance": 0, "id": 15, "order": 1, "query": null, "query_class": null}, {"id": 1, "name": "start0001", "query": null, "query_class": null, "src_dev": "start0001", "type_id": 1}], [{"course_device_type_id": 3, "course_id": 4, "device_id": 2, "distance": 200, "id": 16, "order": 2, "query": null, "query_class": null}, {"id": 2, "name": "int0002", "query": null, "query_class": null, "src_dev": "int0002", "type_id": 1}], [{"course_device_type_id": 3, "course_id": 4, "device_id": 3, "distance": 300, "id": 17, "order": 3, "query": null, "query_class": null}, {"id": 3, "name": "int0003", "query": null, "query_class": null, "src_dev": "int0003", "type_id": 1}], [{"course_device_type_id": 3, "course_id": 4, "device_id": 4, "distance": 400, "id": 18, "order": 4, "query": null, "query_class": null}, {"id": 4, "name": "int0004", "query": null, "query_class": null, "src_dev": "int0004", "type_id": 1}], [{"course_device_type_id": 3, "course_id": 4, "device_id": 5, "distance": 500, "id": 19, "order": 5, "query": null, "query_class": null}, {"id": 5, "name": "int0005", "query": null, "query_class": null, "src_dev": "int0005", "type_id": 1}], [{"course_device_type_id": 2, "course_id": 4, "device_id": 6, "distance": 600, "id": 20, "order": 6, "query": null, "query_class": null}, {"id": 6, "name": "finish0006", "query": null, "query_class": null, "src_dev": "finish0006", "type_id": 1}]], "5": [[{"course_device_type_id": 1, "course_id": 5, "device_id": 15, "distance": 0, "id": 21, "order": 1, "query": null, "query_class": null}, {"id": 15, "name": "start1001", "query": null, "query_class": null, "src_dev": "start1001", "type_id": 1}], [{"course_device_type_id": 1, "course_id": 5, "device_id": 16, "distance": 200, "id": 22, "order": 2, "query": null, "query_class": null}, {"id": 16, "name": "int1002", "query": null, "query_class": null, "src_dev": "int1002", "type_id": 1}], [{"course_device_type_id": 3, "course_id": 5, "device_id": 17, "distance": 300, "id": 23, "order": 3, "query": null, "query_class": null}, {"id": 17, "name": "int1003", "query": null, "query_class": null, "src_dev": "int1003", "type_id": 1}], [{"course_device_type_id": 3, "course_id": 5, "device_id": 18, "distance": 400, "id": 24, "order": 4, "query": null, "query_class": null}, {"id": 18, "name": "int1004", "query": null, "query_class": null, "src_dev": "int1004", "type_id": 1}], [{"course_device_type_id": 1, "course_id": 5, "device_id": 19, "distance": 500, "id": 25, "order": 5, "query": null, "query_class": null}, {"id": 19, "name": "int1005", "query": null, "query_class": null, "src_dev": "int1005", "type_id": 1}], [{"course_device_type_id": 2, "course_id": 5, "device_id": 20, "distance": 600, "id": 26, "order": 6, "query": null, "query_class": null}, {"id": 20, "name": "finish1006", "query": null, "query_class": null, "src_dev": "finish1006", "type_id": 1}]]}');

var keys = Object.keys(courses);

//console.log(courses);
/*var devlist=[  //список устройств
		{
			src_sys:'sys0001',
			src_dev:'start0001',
		},
		{
			src_sys:'sys0001',
			src_dev:'int0002',
		},
		{
			src_sys:'sys0001',
			src_dev:'int0003',
		},
		{
			src_sys:'sys0001',
			src_dev:'int0004',
		},
		{
			src_sys:'sys0001',
			src_dev:'int0005',
		},
		{
			src_sys:'sys0001',
			src_dev:'finish0006',
		}
	];
*/
	function tform(v){
		return moment(v).format('mm:ss.SSSS');
	}
	//форматирование времени
	function dtform(v){
		return moment(v).format('DD.MM.YYYY HH:mm:ss.SSSS');
	}
function run(){
	reqSend(0,0,0,keys[0]);
	reqSend(0,0,0,keys[1]);
}
function reqSend(snum,devnum,starttime,course){
	var devlist=courses[course];
	console.log(snum+" "+devnum+" "+starttime+" "+course);
	console.log(devlist);
	console.log(courses);
	var t=new Date().getTime() ; // 12.850 - 12.859
	if(starttime==0)
		starttime= new Date().getTime();
	$("#data"+course).append("<tr><td>"+startlist[snum]+"</td><td>"+devlist[devnum].src_dev+"</td><td>"+devlist[devnum].src_sys+"</td><td>"+(t-starttime)+"</td><td>"+tform(t-starttime)+"</td><td>"+t+"</td><td>"+dtform(t)+"</td></tr>");
	$.ajax({
		  url: "/raceinfo/input/data",
			type: 'POST',
		  dataType: 'json',
		  type: 'POST',
		  contentType: 'application/json',
		  data:JSON.stringify({
			  'SRC_SYS':devlist[devnum][1].name,
			  'SRC_DEV':devlist[devnum][1].name,
			  'BIB':startlist[snum],
			  'EVENT_CODE':'x3',
				'GROUP_CODE':'50',
			  'TIME':dtform(t),
			  'TOKEN':'pwreutv02n8414yt8'
			  })
		}).done(function() {
//			  $( this ).addClass( "done" );
		});
//    alert("dev=" + devlist[devnum].src_dev + " bib=" + snum + " time="+t);
	var sectordelay=100; //1sec
//	console.log(snum,devnum,starttime);

	if(devnum==devlist.length-1){
		devnum=0;
		snum++;
		starttime=0;
		$("#data"+course).append("<tr><td colspan=7><hr><!--<button class='btn' onclick='setTimeout(reqSend, 100+(Math.random()*1840), "+snum+", "+devnum+",0)'>Next competitor</button>--></td></tr>");
	}else{
		devnum++;
		//if(snum<=startlist.length-1)
			setTimeout(reqSend, sectordelay+(Math.random()*1840), snum, devnum,starttime,course);

	}



}

</script>
<!--
<input type="button" onclick="clearInterval(intervalID);" value="stop"> |
<input type="text" id="delay_val" value="100"><input type="button" value="change delay" onclick="delay=$('#delay_val').val();clearInterval(intervalID);intervalID = window.setInterval(reqSend, delay);">
 -->
<input type="button" onclick="run();" value="Run">
<a href="/raceinfo/emulation/1/clear">Clear all results</a>
<HR>
<table id="data4" style="width:49%; float:left">
<tr><td>№</td><td>src_dev</td><td>src_sys</td><td>timediff (ms)</td><td>timediff</td><td>current timestamp (ms)</td><td>current datetime</td></tr>
</table>
<table id="data5" style="width:49%; float:left">
<tr><td>№</td><td>src_dev</td><td>src_sys</td><td>timediff (ms)</td><td>timediff</td><td>current timestamp (ms)</td><td>current datetime</td></tr>
</table>
<!-- <table id="log" style="width:49%; margin-left:1%; float:left">
<tr><td>#</td><td>delay</td><td>time s.ms</td></tr>
</table>
 -->
 </html>
