{% extends "shorttrack/base.html" %}
{% import "_user.html" as macros %}

{% block title %} Получатель{% endblock %}

{% block page_content %}
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.6/socket.io.min.js"></script>
    <ul class="nav nav-tabs">
      <li id="li_tab_results"><a href="#tab_results" data-toggle="tab">Результаты</a></li>
      <li id="li_tab_runs"><a href="#tab_runs" data-toggle="tab">Заезды</a></li>
      <li id="li_tab_runlists"><a href="#tab_runlists" data-toggle="tab">Стартовые списки</a></li>
    </ul>
    <div class="tab-content">
      <div id="tab_results" class="tab-pane fade in active">
        <div class="row">
            <h2>Результаты</h2>
        </div>
        {% for key, groups in competitors.items() %}
            <div class="row">
                <h3>Заезд - {{key}}</h3>
            </div>
            {% for group, list in groups.items() %}
                <div class="row">
                    <h4>Группа - {{group}}</h4>
                </div>
                <div class="row">
                {% for item in list %}
                    <table id="Competitor-{{key}}-{{item.id}}" style="width:19%; float:left">
                        <tr>
                            <th colspan="3">{{item.ru_lastname}} {{item.ru_firstname}}</th>
                        </tr>
                        <tr>
                            <th>Circle</th>
                            <th>Rank</th>
                            <th>Time</th>
                            <th>Diff</th>
                        </tr>
                    </table>
                {% endfor %}
                </div>
            {% endfor %}
        {% endfor %}
      </div>
      <div id="tab_runs" class="tab-pane fade">
          <h2>Заезды</h2>
                <table style="width:100%;" class="run_list table table-bordered">
                    <tr>
                        <th>№</th>
                        <th>Order</th>
                        <th>Name</th>
                        <th>starttime</th>
                        <th>endtime</th>
                        <th></th>
                    </tr>
               {% for item in runs %}
                    <tr run_id='{{item.id}}'>
                        <td>{{item.id}}</td>
                        <td>{{item.number}}</td>
                        <td>{{item.name}}</td>
                        <td class="start__time">{{item.starttime}}</td>
                        <td class="finish__time">{{item.endtime}}</td>
                        <td>
                            <button type="button" class="run__start btn btn-success">Start</button>
                            <button type="button" class="run__finish btn btn-danger" >Finish</button>
                        </td>
                    </tr>
               {% endfor %}
                </table>

      </div>
      <div id="tab_runlists" class="tab-pane fade">
        <div class="row"><h2>Стартовые списки</h2></div>
        {% for key, groups in competitors.items() %}
            <div class="row">
                <h3>Заезд - {{key}}</h3>
            </div>
            {% for group, list in groups.items() %}
                    <table style="width:25%; float:left">
                        <tr>
                            <th colspan="2">Группа - {{group}}</th>
                        </tr>
                        <tr>
                            <th>Order</th>
                            <th>Name</th>
                            <th></th>
                        </tr>
                        {% for item in list %}
                        <tr>
                            <td>{{loop.index}}</td>
                            <td>{{item.ru_lastname}} {{item.ru_firstname}}</td>
                            <td>
                                <a data-toggle="modal" title="Photofinish" class="open-PhotofinishModal btn btn-primary" href="#PhotofinishModal">test</a>
                            </td>
                        </tr>
                        {% endfor %}
                    </table>

            {% endfor %}
        {% endfor %}
      </div>
</div>

<div class="modal hide" id="PhotofinishModal">
 <div class="modal-header">
    <button class="close" data-dismiss="modal">×</button>
    <h3>Modal header</h3>
  </div>
    <div class="modal-body">
        <p>some content</p>
    </div>
</div>

{% endblock %}
{% block scripts %}
{{ super() }}
<script>
  var socket = io.connect('http://127.0.0.1:5000');
  var race_id ={{race_id}};
  var daa;
    socket.on('STNewDataPoint', function(data) {
     data= JSON.parse(data);
     $("#Competitor-"+data.run_id+"-"+data.competitor_id).append("<tr><td>"+data.device_order+"</td><td>"+data.rank+"</td><td>"+data.time+"</td><td>"+data.diff+"</td></tr>");
    });
    socket.emit('GetResults', {race_id: 8});

    socket.on('Results', function(data) {
      console.log('Results', JSON.parse(data));
    });

    $('.run__start').click(function() {
        var cid=$(this).closest('tr').attr('run_id');
        $.post( '/shorttrack/race/'+race_id+'/run/'+cid+'/start').
            done(function(data) {
               $( "tr[run_id='"+cid+"']").children('.start__time').html(data);
            });
    });
    $('.run__finish').click(function() {
        var cid=$(this).closest('tr').attr('run_id');
        $.post( '/shorttrack/race/'+race_id+'/run/'+cid+'/stop').
            done(function(data) {
               $( "tr[run_id='"+cid+"']").children('.finish__time').html(data);
            });
    });

    $(document).on("click", ".open-PhotofinishModal", function () {
//     var myBookId = $(this).data('id');
//     $(".modal-body #bookId").val( myBookId );
     // As pointed out in comments,
     // it is superfluous to have to manually call the modal.
      $('#PhotofinishModal').modal('show');
});

</script>
{% endblock %}
