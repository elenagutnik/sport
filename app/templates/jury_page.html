{% extends "raceinfo/base.html" %}
{% import "_user.html" as macros %}

{% block title %} Получатель{% endblock %}

{% block page_content %}
<style>
.btn {margin-right: 10px;}
.table-bordered tr.row_competitor td {border-top:3px solid #ababab!important;}
#btn_raceresults {margin:20px 0;}
#table_raceresults thead th {text-align:center;vertical-align: middle; border-bottom-width: 1px;}
#tab_summarytable table  th.row1 {padding:0; margin:0;border-bottom-width: 1px;}
#tab_summarytable table  th.row1 div {float:left; border-right:1px solid #ddd; padding:5px 10px;height:37px;}
#tab_summarytable table  th.row1  div.bib { width:7%; line-height: 2em;}
#tab_summarytable table  th.row1  div.name { width:55%; line-height: 2em;}
#tab_summarytable table  th.row1  div.rank { width:7%; line-height: 2em;}
#tab_summarytable table  th.row1  div.time { width:14%; line-height: 2em;}
#tab_summarytable table  th.row1  div.status {float:left; width:8%; line-height: 2em;}
#tab_summarytable table  th.row1  div.manual {float:left; border:none; width:1%; line-height: 2em;}
#tab_summarytable table  th.row1  div.btns {margin:0;float:right; border: none;}
#tab_summarytable table  th.row1  div.btns button {float:right; min-width:5%; margin:0;}
#tab_summarytable table  th.row1  div.btns .btn-sm { padding: 3px 5px;}
#tab_summarytable table td {width:auto;}

#tab_startlist table tbody tr.disabled td{color:#bbbbbb}

#ScoreBoard {
  text-align: right;
  margin: 0 0 20px 0;
}
</style>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.6/socket.io.min.js"></script>

    <div id="ScoreBoard">
      <span id="ScoreBoardState">
        <button type="button" class="btn btn-primary btn-sm" id="btn_ScoreBoardConnect" data-dismiss="modal">Connect</button>
      </span>
      <span id="ScoreBoardSwitcher">
        ScoreBoard: <input type="checkbox" data-toggle="toggle" data-size="mini" name="ScoreBoardSwitcher">
      </span>
    </div>
    <ul class="nav nav-tabs">
      <li id="li_tab_races" class="active"><a href="#tab_races" data-toggle="tab">Соревнование</a></li>
      <li id="li_tab_runs"><a href="#tab_runs" data-toggle="tab">Заезды</a></li>
      <li id="li_tab_startlist"><a href="#tab_startlist" data-toggle="tab">Стартовые списки</a></li>
      <li id="li_tab_curcompetitor"><a href="#tab_curcompetitor" data-toggle="tab">Старт и редактирование</a></li>
      <li id="li_tab_summarytable"><a href="#tab_summarytable" data-toggle="tab">Все результаты</a></li>
      <li id="li_tab_datasrc"><a href="#tab_datasrc" data-toggle="tab">Данные с устройств</a></li>
      <li id="li_tab_device"><a href="#tab_device" data-toggle="tab">Устройства</a></li>
      <li id="li_tab_raceresults"><a href="#tab_raceresults" data-toggle="tab">Результаты</a></li>
      <li id="li_tab_reports"><a href="#tab_reports" data-toggle="tab">Отчеты</a></li>
    </ul>
    <div class="tab-content">
        <div id="tab_races" class="tab-pane fade in active">
          <h2>Соревнования</h2>
          Выбранная гонка: <b><div class="current_race">не выбрана</div></b>
          <br>
          Выбрать другую гонку:<br>
          <select id="select_race">
          </select>
          <br>
          <br>
          <button type="button" class="btn btn-primary btn-sm" id="btn_setrace" data-dismiss="modal">Выбрать</button>

        </div>
        <div id="tab_runs" class="tab-pane fade">
          <h2>Заезды</h2>
          <h3>Current run <span id="run_current"></span></h3>
          <button type="button" class="btn btn-primary btn-sm" id="btn_frunners_start" data-dismiss="modal">Запустить Forerunners заезд</button>
          <button type="button" class="btn btn-primary btn-sm" id="btn_frunners_stop" data-dismiss="modal">Остановить Forerunners заезд</button>
          <br><br>
          <table style="width:100%;" class="table table-bordered">
            <thead>
              <tr>
                <th>№</th>
                <th>Start time</th>
                <th>End time</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="run_list_tbody">
            </tbody>
          </table>
        </div>
        <div id="tab_startlist" class="tab-pane fade"></div>
        <div id="tab_summarytable" class="tab-pane fade">
          <h2>Summary tables</h2>

        </div>
        <div id="tab_curcompetitor" class="tab-pane fade">
          <h2>Controls</h2>
          <table id="tab_manualcontrol" class="table">
            <tbody>
            </tbody>
          </table>
        </div>
        <div id="tab_device" class="tab-pane fade"></div>
        <div id="tab_datasrc" class="tab-pane fade">
            <div class="hidden">
              <select id="src_select_bib" class="src_select_bib" style="clear:both;">
                <option value="">Не меняем</option>
                <option value="-1">Не этот спортсмен</option>
                <option value="-2">Помеха</option>
              </select>
            </div>
            <table id="tab_data_src" class="table table-hover">
              <thead>
                <tr>
                  <th>run_id</th>
                  <th>course_id</th>
                  <th>device</th>
                  <th>(absolute) time</th>

                  <th>bib</th>
                  <th>name</th>
                  <th>act | copy to new competitor</th>
                </tr>
              </thead>
              <tbody>
              </tbody>
            </table>
        </div>
        <div id="tab_raceresults" class="tab-pane fade">
          <button type="button" class="btn btn-primary btn_raceresults" id="btn_raceresults" data-dismiss="modal">Get/Refresh Results</button>
          <div id="tab_raceresults_btn" style="float:right;margin: 20px 0;"></div>
          <table style='width:100%;' class='table table-bordered' id="table_raceresults">
          </table>
        </div>
        <div id="tab_reports" class="tab-pane fade">
            <h2>Отчеты</h2>
            Отчеты формируются по сформированным на данный момент результатам.
            <bR>
            Для пересчета результатов кликаем сюда:
            <button type="button" class="btn btn-primary btn_raceresults" id="btn_raceresults2" data-dismiss="modal">Get/Refresh Results</button>
            <br><br>
            <hr>
            <h3>Поля в отчетах:</h3>
            <form method="" target="_blank" action="" name="form_reportfields" class="form"  id="form_reportfields">
              <div class="form-group row">
                <div class="col-md-6">
                  <label class="control-label" for="ffactor">F-factor:</label>
                  <input type="text" class="form-control" name="fields_ffactor" id="ffactor">
                </div>
                <div class="col-md-6">
                  <label class="control-label" for="penalty">Applied Penalty:</label>
                  <input type="text" class="form-control" name="fields_penalty" id="penalty">
                </div>
                <div class="col-md-12">
                  <label class="control-label" for="reasondesc">Reasons description:</label>
                  <textarea class="form-control" name="fields_reasondesc" id="reasondesc"></textarea>
                </div>
              </div>
            </form>
            <hr>
            <h3>Стартовые листы</h3>
            <button type="button" class="btn btn-primary btn_report" data-dismiss="modal" name="startlist">Start List</button>
            <button type="button" class="btn btn-primary btn_report" data-dismiss="modal" name="startlist1">Start List - Run 1</button>
            <button type="button" class="btn btn-primary btn_report" data-dismiss="modal" name="startlist2">Start List - Run 2</button>
            <button type="button" class="btn btn-primary btn_report" data-dismiss="modal" name="startlist3">Start List - Run 3</button>
            <hr>
            <h3>Результаты</h3>
            <button type="button" class="btn btn-primary btn_report" data-dismiss="modal" name="results_C73C_first">Unofficial Results (After Run 1)</button>
            <button type="button" class="btn btn-primary btn_report" data-dismiss="modal" name="results_C73C_un">#C73C - Unofficial Results (After Run 2)</button>
            <button type="button" class="btn btn-primary btn_report" data-dismiss="modal" name="results_C73C">#C73C - Official Results (After Run 2)</button>

        </div>
    <!-- HTML-код модального окна -->
    <div id="popup_editresult" class="modal fade">
      <div class="modal-dialog">
        <div class="modal-content">
          <form action="" name="form_editresult" class="form"  id="form_editresult">
          <!-- Заголовок модального окна -->
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
            <div class="modal-title"><h2>Ручной ввод результатов:</h2>
              <h3>
                Спортсмен: <span id="form_txt_competitor"></span>
                <BR>
                Заезд: <span id="form_txt_run"></span>
              </h3>
            </div>
          </div>
          <!-- Основное содержимое модального окна -->
          <div class="modal-body">
            <div class="container-fluid">
              <!-- Контейнер, в котором можно создавать классы системы сеток -->
              <div class="form-group row">
                <div class="col-md-12">
                  <label class="control-label" for="form_status">Status:</label>
                  <select class="form-control" name="status" id="form_status"></select>
                </div>
              </div>
              <div class="form-group row">
                <div class="col-md-6">
                  <label class="control-label" for="form_starttime">Start Time:</label>
                  <input type="text" class="form-control" name="starttime" id="form_starttime">
                </div>
                <div class="col-md-6">
                  <label class="control-label" for="form_finishtime">Finish Time:</label>
                  <input type="text" class="form-control" name="finishtime" id="form_finishtime">
                </div>
              </div>
              <div class="form-group row">
                <div class="col-md-10">
                  <label class="control-label" for="form_reason">Reason:</label>
                  <input type="text" class="form-control" name="reason" id="form_reason">
                </div>
                <div class="col-md-2">
                  <label class="control-label" for="form_gate">Gate:</label>
                  <input type="text" class="form-control" name="gate" id="form_gate">
                </div>
              </div>
            </div>
          </div>
          <!-- Футер модального окна -->
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Закрыть</button>
            <button type="button" class="btn btn-primary editform_approve">Approve</button>

            <input type="hidden" id="form_competitor_id" name="competitor_id" value="">
            <input type="hidden" id="form_run_id" name="run_id" value="">

          </div>
        </form>
        </div>
      </div>
    </div>

    {% endblock %}

    {% block scripts %}
    {{ super() }}

    <script type="text/javascript">
    var err_critical=null;
    var err_log=new Array();

    var race_id=null;
    var race=null;// пока задаем вручную
    var race_info = null;
    var run={'id':null,'number':null}; // активный заезд
    console.log("init run:",run);
    var run_list=new Array(); // список всех заездов для race_id отсортированных по порядку (number)
    var run_list_ids=new Array(); // массив run_list_ids[run_id]=run_list[index] - соответствие id_run элементам в массиве run_list'

    var comp_state=new Array();
    var glob_arr = new Array();

    var status_list; //список статусов
    var start_list; //стартовые списки на все заезды
    var course_list=new Array(); // список трасс на гонке
    var device_list=new Array();;

    var thead={};

    var socket = io.connect('http://127.0.0.1:5000');

    socket.on('errorData', function(data) {
      var data=JSON.parse(data);
      console.log("errorData",data);
    });
    socket.on('errorHandler', function(data) {
      var data=JSON.parse(data);
      console.log(data);
    });
    /*
    socket.on('get/results/response', function(data) {
      console.log("socket.on('get/results/response', function(data)");
      var sdata=JSON.parse(data);

      console.log(sdata);
      console.log("----------------------------------------------");

      $("#tab_data_src tbody").html('');
      //обраотка ту
      for(var i=0;i<sdata.length; i++){
        add2datasrc(sdata[i]);
      }
      //glob_arr.length = 0; // очищаем массив
      clear_resulttables();
      delete glob_arr;
      //glob_arr["run"+run.id].length);
      get_current_data(race_id);
    });
    */
    socket.on('change/data_in/error', function(data) {
      console.log('change/data_in/error');
      console.log(JSON.parse(data));
    });
/*
    function clear_resulttables(){
      for(var i=0;i<run_list.length;i++){
        if(glob_arr){
          if(glob_arr["run"+run_list[i].id]){
            glob_arr["run"+run_list[i].id]=null;
          }
        }
      }

      $("#tab_summarytable").html('');
      prepare_result_tables();
    }
*/
    socket.on('get/results/current', function(data){
      add2datasrc(JSON.parse(data)[0]);
    });
    socket.on('ScoreboardStatus', function(data) {
      var data=JSON.parse(data);
      console.log("ScoreboardStatus(data)",data);
    });
    socket.on('NewDataPoint', function(data) {
      var data=JSON.parse(data);
      //console.log("NewDataPoint", data);
      NewDataPoint(data);
    });
    function NewDataPoint(data){
      var fields_current=Array("absoluttime", "time", "rank", "diff", "sectortime", "sectorrank", "sectordiff", "speed");
      var fields_all=Array("rank", "sectorrank");
      console.log("NewDataPoint", data);
      $.each(data, function(run,arr){
          $.each(arr[0], function(course,arr){
            $.each(arr, function(comp,val){
              for(var i=0;i<fields_current.length;i++){
                  $("#tab_summarytable .div_run"+run+" table.run"+run+"_course"+course+" tbody tr.comp_"+comp+"_"+fields_current[i]+" td.dev_"+val.course_device_id).html(val[fields_current[i]]);
              }
            });
          });
          $.each(arr[1], function(course,arr){
            console.log("arr[1]",arr);
            $.each(arr, function(dev,allcomps){
              console.log("$.each(arr, function(dev,allcomps)",allcomps);
              $.each(allcomps, function(comp,val){
                console.log("$.each(allcomps, function(comp,val)",val);
                for(var i=0;i<fields_all.length;i++){
                  $("#tab_summarytable .div_run"+run+" table.run"+run+"_course"+course+" tbody tr.comp_"+comp+"_"+fields_all[i]+" td.dev_"+dev).html(val[fields_all[i]]);
                }
              });
            });
          });
    //        });
      });
    }
    socket.on('NewDataStart', function(data) {
      var data=JSON.parse(data);
      NewDataStart(data);
    });
    /*
    function showhide(run,comp,el){
      val=el.value;
      var fields=Array("absoluttime", "time", "rank", "diff", "sectortime", "sectorrank", "sectordiff", "speed", "thead");
      if(val=="+"){
        for(var i=0;i<fields.length;i++){
          $("#tab_summarytable .div_run"+run+" tbody tr.comp_"+comp+"_"+fields[i]).show();
        }
        $("#tab_summarytable .div_run"+run+" tbody tr.comp_"+comp+" div.btn button").prop('value', '-');
        $("#tab_summarytable .div_run"+run+" tbody tr.comp_"+comp+" div.btn button").html("-");

        el.value="-";
      }else{
        for(var i=0;i<fields.length;i++){
          $("#tab_summarytable .div_run"+run+" tbody tr.comp_"+comp+"_"+fields[i]).hide();
        }
        $("#tab_summarytable .div_run"+run+" tbody tr.comp_"+comp+" div.btn button").prop('value', '+');
        $("#tab_summarytable .div_run"+run+" tbody tr.comp_"+comp+" div.btn button").html("+");
        el.value="+";
      }
    }
    */
    function hidedetails(run,comp){
      if($("#tab_summarytable .div_run"+run+" tbody tr.comp_"+comp+" div.status").html!="N/A"){
        var fields=Array("absoluttime", "time", "rank", "diff", "sectortime", "sectorrank", "sectordiff", "speed", "thead");

        for(var i=0;i<fields.length;i++){
          $("#tab_summarytable .div_run"+run+" tbody tr.comp_"+comp+"_"+fields[i]).hide();
        }
        $("#tab_summarytable .div_run"+run+" tbody tr.comp_"+comp+" div.btn button").prop('value', '+');
        $("#tab_summarytable .div_run"+run+" tbody tr.comp_"+comp+" div.btn button").html("+");
      }
    }
    function NewDataStart(data){
      var fields=Array("absoluttime", "time", "rank", "diff", "sectortime", "sectorrank", "sectordiff", "speed");
      var status_started="Started";
      var status_classname="started";

      console.log(data);

      $.each(data, function(run,arr){
    //        $.each(arr[0], function(course,arr){
        $.each(arr, function(course,arr){
          if($("#tab_summarytable .div_run"+run+" tbody tr") && $("#tab_summarytable .div_run"+run+" table.run"+run+"_course"+course+" tbody tr").length){
            var prev_comp=parseInt($("#tab_summarytable .div_run"+run+" table.run"+run+"_course"+course+" tbody tr")[$("#tab_summarytable .div_run"+run+" tbody tr").length-1].className.replace(/\D+/g,""));
            hidedetails(run, prev_comp);
          }
          $.each(arr, function(comp,val){
            console.log("run",run);
            console.log("course",course);
            console.log("comp",comp);
            var comp_obj=getObjById(race_info.run_list[run].start_list[course],"race_competitor_id",comp);
            console.log("comp_obj",comp_obj);
            comp_obj.name=getCompName(comp_obj);
            $("#tab_summarytable .div_run"+run+" table.run"+run+"_course"+course+" tbody").append("\
              <tr class='comp_"+comp+" started'>\
                <th class='row1' colspan="+(objlen(race_info.run_list[run].courses[course].devices)+1)+">\
                  <div class='bib'>"+comp_obj.bib+"</div>\
                  <div class='name'>"+comp_obj.name+"</div>\
                  <div class='rank'>N/A</div>\
                  <div class='time'>N/A</div>\
                  <div class='status'>"+status_started+"</div>\
                  <div class='btns'>\
                    <button type=button class='showhide_comp_results btn btn-sm' run='"+run+"' competitor='"+comp+"' value='+'>\
                      <span class='glyphicon glyphicon-chevron-down' aria-hidden='true'></span>\
                    </button>\
                  </div>\
                </th>\
              </tr>\
              <tr class='row2 comp_"+comp+"_thead'>\
                <th>Parameter</th>"+thead[run][course]+"\
              </tr>\
              ");
            for(var i=0;i<fields.length;i++){
                $("#tab_summarytable .div_run"+run+" table.run"+run+"_course"+course+" tbody").append("<tr class='comp_"+comp+"_"+fields[i]+"'><th class='title'>"+fields[i]+"</th></tr>");
                $.each(race_info.run_list[run].courses[course].devices, function(idx, dev){
                  $("#tab_summarytable .div_run"+run+" table.run"+run+"_course"+course+" tbody tr.comp_"+comp+"_"+fields[i]).append("<td class='dev_"+dev.id+"'></td>");
                });
                $("#tab_summarytable .div_run"+run+" table.run"+run+"_course"+course+" tbody tr.comp_"+comp+"_"+fields[i]+" td.dev_"+val.course_device_id).html(val[fields[i]]);
            }
            tab_summarytable_set_status(run,course,comp,status_started,false);
          });
        });
      });
    }
    socket.on('NewDataFinish', function(data) {
      var data=JSON.parse(data);
      NewDataFinish(data);
    });
    function NewDataFinish(data){
      var fields_current =  Array("absoluttime", "time", "rank", "diff", "sectortime", "sectorrank", "sectordiff", "speed");
      var fields_all=Array("rank", "diff", "sectorrank", "sectordiff");
      console.log("NewDataFinish", data);
      $.each(data, function(run,arr){
        $.each(arr[0], function(course,arr){
          $.each(arr, function(comp,val){
            for(var i=0;i<fields_current.length;i++){
                $("#tab_summarytable .div_run"+run+" table.run"+run+"_course"+course+" tbody tr.comp_"+comp+"_"+fields_current[i]+" td.dev_"+val.course_device_id).html(val[fields_current[i]]);
            }
            var status_name=getObjById(status_list,"id",val.status_id).name;
            $("#tab_summarytable .div_run"+run+" table.run"+run+"_course"+course+" tbody tr.comp_"+comp+" div.status").html(status_name);
            $("#tab_summarytable .div_run"+run+" table.run"+run+"_course"+course+" tbody tr.comp_"+comp+" div.time").html(val.time);
            $("#tab_summarytable .div_run"+run+" table.run"+run+"_course"+course+" tbody tr.comp_"+comp+" div.rank").html(val.rank);
            tab_summarytable_set_status(run,course,comp,status_name,val.status_id);
          });
        });
        $.each(arr[1], function(course,arr){
          $.each(arr, function(dev,allcomps){
            $.each(allcomps, function(comp,val){
              for(var i=0;i<fields_all.length;i++){
                $("#tab_summarytable .div_run"+run+" table.run"+run+"_course"+course+" tbody tr.comp_"+comp+"_"+fields_all[i]+" td.dev_"+dev).html(val[fields_all[i]]);
              }
            });
          });
          var fin=arr[Object.keys(arr)[objlen(arr)-1]];
          $.each(fin, function(comp,val){
            $("#tab_summarytable .div_run"+run+" table.run"+run+"_course"+course+" tbody tr.comp_"+comp+" div.rank").html(val["rank"]);
          });
        });
      });
    }
    function tab_summarytable_set_status(run,course,comp,status_name,status_id){
      var el="#tab_manualcontrol table.tab_run"+run+"_course"+course+" tr.tr_"+comp;
      if(status_name=="started" || status_name=="On Start"){
        $(el).addClass("danger");
        $(el).removeClass("success");
        $(el).removeClass("warning");
        $(el+" button.btn_start").hide();
      }else if(status_id==1){
        $(el).addClass("success");;
        $(el).removeClass("danger");
        $(el).removeClass("warning");
        $(el+" button.btn_start").hide();
      }else{
        $(el).addClass("warning");
        $(el).removeClass("success");;
        $(el).removeClass("danger");
        $(el+" button.btn_start").hide();
      }
      $(el+" td.status").html(status_name);
      return true;
    }
    socket.on('Results', function(data) {
      var data=JSON.parse(data);
      console.log("socket.on('Results'",data);
      RefreshResults(data);
    });

    socket.on('ForerunnersResults', function(data) {
      console.log("socket.on('ForerunnersResultsResults'");
      var data=JSON.parse(data);
      console.log(data);
      //RefreshResults(data);
    });


    function create_cells(run, course, arr){ //arr = devices with competitors data
      console.log("create_cells",arr);
      var d = arr[Object.keys(arr)[objlen(arr)-1]];
      var fields=Array("absoluttime", "time", "rank", "diff", "sectortime", "sectorrank", "sectordiff", "speed");
      var devcols=objlen(race_info.run_list[run].courses[course].devices);//количество девайсов на трассе

      console.log("race_info.run_list",race_info.run_list);
      console.log("run",run);
      console.log("course",course);

      var comp_sorted_tmp=race_info.run_list[run].start_list[course];
      var comp_sorted=Array();
      comp_sorted_tmp.sort(function(a,b){return a['manual_order'] == b['manual_order'] ? a > b : a['manual_order'] > b['manual_order']}); // сортируем спортсменов
      for(var id in comp_sorted_tmp){
          if(comp_sorted_tmp[id].manual_order!==null)
          comp_sorted.push(comp_sorted_tmp[id]);
      }

      for(var id in comp_sorted){
        var comp_obj=comp_sorted[id];
        var name = getCompName(comp_sorted[id]);
        var comp=comp_sorted[id].race_competitor_id;
        var val=d[comp];

        var status_name = val.status_id?getObjById(status_list,"id",val.status_id).name:"N/A";
        $("#tab_summarytable .div_run"+run+" table.run"+run+"_course"+course+" tbody").append("\
          <tr class='comp_"+comp+"'>\
            <th class='row1' colspan="+(devcols+1)+">\
              <div class='bib'>"+comp_obj.bib+"</div>\
              <div class='name'>"+name+"</div>\
              <div class='rank'>"+(val.rank?val.rank:"N/A")+"</div>\
              <div class='time'>"+(val.time?val.time:"N/A")+"</div>\
              <div class='status' status_id='"+val.status_id+"'>"+status_name+"</div>\
              <div class='manual' val='"+val.is_manual+"'>"+(val.is_manual?"<span class='glyphicon glyphicon-pencil' title='Manual Input'></span>":"")+"</div>\
              <div class='btns'>\
                <button type=button class='showhide_comp_results btn btn-sm' run='"+run+"' competitor='"+comp+"' value='+'>\
                  <span class='glyphicon glyphicon-chevron-down' aria-hidden='true'></span>\
                </button>\
              </div>\
            </th>\
          </tr>");
        if(val.status_id!=1){
          $("#tab_summarytable .div_run"+run+" table.run"+run+"_course"+course+" tbody").append("\
          <tr class='row2 comp_"+comp+"_thead'>\
          <th colspan="+(devcols+1)+">\
            Reason: <span class='reason'>"+val.reason+"</span>\
            Gate: <span class='gate'>"+val.gate+"</span>\
          </th>\
          </tr>");
        }else{
          $("#tab_summarytable .div_run"+run+" table.run"+run+"_course"+course+" tbody").append("\
            <tr class='row2 comp_"+comp+"_thead'>\
              <th>Parameter</th>"+thead[run][course]+"\
            </tr>\
            ");
          console.log("val",val);
          for(var i=0;i<fields.length;i++){
              $("#tab_summarytable .div_run"+run+" table.run"+run+"_course"+course+" tbody").append("<tr class='comp_"+comp+"_"+fields[i]+"'><th class='title'>"+fields[i]+"</th></tr>");
              console.log("race_info.run_list[run].courses[course].devices",race_info.run_list[run].courses[course].devices);
              $.each(race_info.run_list[run].courses[course].devices, function(idx, dev){
                $("#tab_summarytable .div_run"+run+" table.run"+run+"_course"+course+" tbody tr.comp_"+comp+"_"+fields[i]).append("<td class='dev_"+dev.id+"'>==="+((arr[dev.order][comp]&&arr[dev.order][comp][fields[i]])?arr[dev.order][comp][fields[i]]:"")+"</td>");
              });
              //console.log("#tab_summarytable .div_run"+run+" table.run"+run+"_course"+course+" tbody tr.comp_"+comp+"_"+fields[i]+" td.dev_"+val.course_device_id, "==="+val[fields[i]]);
              //$("#tab_summarytable .div_run"+run+" table.run"+run+"_course"+course+" tbody tr.comp_"+comp+"_"+fields[i]+" td.dev_"+val.course_device_id).html("==="+val[fields[i]]);
          }
        }
        hidedetails(run,comp);
        tab_summarytable_set_status(run,comp,status_name,val.status_id);

      }


    }
    function RefreshResults(data){
      var fields=Array("absoluttime", "time", "rank", "diff", "sectortime", "sectorrank", "sectordiff", "speed");
      //?????
      prepare_result_tables();
      /*if(typeof $("#tab_summarytable .div_run"+run.id) == "undefined" || $("#tab_summarytable .div_run"+run.id).length==0){
        prepare_result_tables_for_run(run.id);
      }
      */

      console.log("RefreshResults", data);
      $.each(data, function(run,arr){
        console.log("run="+run);
        if(!$("#tab_summarytable .div_run"+run) || !$("#tab_summarytable .div_run"+run).length){
          prepare_result_tables_for_run(run,arr);
        }
        $("#tab_summarytable .div_run"+run+" tbody").html("");
        $.each(arr[0], function(course,arr){
          console.log("course="+course);
          create_cells(run,course,arr); // создание ячеек
          $.each(arr, function(dev,allcomps){
            var dev_id=race_info.run_list[run].courses[course].devices[dev-1].id;
            console.log("#576 dev_id="+dev_id);
            $.each(allcomps, function(comp,val){
              console.log("comp="+comp);
              console.log(val);
              $.each(fields, function(field_k, field_val){
                console.log("#tab_summarytable .div_run"+run+" table.run"+run+"_course"+course+" tbody tr.comp_"+comp+"_"+field_val+" td.dev_"+dev_id,val[field_val]);
                $("#tab_summarytable .div_run"+run+" table.run"+run+"_course"+course+" tbody tr.comp_"+comp+"_"+field_val+" td.dev_"+dev_id).html(val[field_val]);
              });
              var status_name = val.status_id?getObjById(status_list,"id",val.status_id).name:"N/A";
              tab_summarytable_set_status(run,course,comp,status_name,val.status_id);
            });
          });
        });
      });
    }

    socket.on('RaceInfo', function(data) {
      console.log("socket.on('RaceInfo'");
      race_info=JSON.parse(data);
      run=get_active_run(race_info.run_list);
      console.log("init run:",run);
      Promise.all([
        set_html_runlist(),
        set_select_bib(),
        startlist_tab_prepare()])
      /*.then(
            result=>courselist_get()              // получение и внесение информации для вкладки "Устройства на трассах" (#tab_device)
      ).then(
            result=>courselist_tab_prepare()
      ).then(
            result=>prepare_result_tables()
      )*/.then(

            result=>set_list_for_manualcontrol()
      ).then(
            result=>socket_emit('GetResults',{'race_id':race_id})//socket.emit('get/results', {run_id: 1}) //result=>get_current_data(race_id)
      ).then(
            result=>socket_emit_emptyobj('GetScoreboardStatus')
      );
      console.log('RaceInfo',race_info);
    });



    //////////////////////////////////////////////
    var err_list= new Array();
    err_list["code_1"]={
        "critical":true,
        "msg":"не выбрана гонка"
      };





    // обработка кнопки сохранения и апрува для ручного ввода результата
    socket.on('NewDataManual', function(data){
      var data=JSON.parse(data);
      console.log("data", data);
    });
    function err2log(code){
    err_log.push(code);
    if(err_list["code_"+code].critical)err_critical=code;
    }
    function add_error(data){
    console.log("add_error", data);
    }
    function get_race_list(){
        console.log("START FUNC: get_race_list");
        race_id=Number(getCookie("race_id"));
        return $.get("/raceinfo/race/get")
        .done(function(data){
            race_list=JSON.parse(data);
            $.each(race_list, function(value) {
              $("#select_race").append($("<option></option>", {value: this.id, text: this.eventname}));
              if(this.id==race_id)
                race={"id":this.id, "eventname":this.eventname};
            });
            if(race_id){
              $("#select_race").val(race_id);
              $("#tab_races div.current_race").html(race.eventname);
              console.log("END FUNC: get_race_list : race_list");
              return race_list;
            }else{
              err2log(1);
              $(".nav-tabs").hide();
              $("#tab_runs").hide();
              $("#tab_startlist").hide();
              $("#tab_curcompetitor").hide();
              $("#tab_summarytable").hide();
              $("#tab_datasrc").hide();
              $("#tab_device").hide();
              $("#tab_raceresults").hide();
              console.log("END FUNC: get_race_list : false");
              return new Error("Network Error");
            }
        })
    }
    // получаем список статусов
    function get_status_list(){
        console.log("START FUNC: get_status_list");
        return $.get("/raceinfo/status/get")
        .done(function(data){
          status_list=JSON.parse(data);
          $.each(status_list, function(value) {
            $("#form_status").append($("<option></option>", {value: this.id, text: this.name+" - "+this.description}));
          });
          console.log("END FUNC: get_status_list");
          return status_list;
        })
    }
    function get_runs_list(){
        console.log("START FUNC: get_runs_list");
        return $.ajax({
          type: "GET",
          url: "/raceinfo/run/get/",
          data: {
            'race_id': race_id
            }
        })
        .done(function(data){
            run_list = JSON.parse(data);
            console.log("get_runs_list", JSON.parse(data));
            console.log("get_runs_list-race_info", race_info);
            run_list.sort(function(a,b){return a['number'] == b['number'] ? a > b : a['number'] > b['number']}); // сортируем заезды по порядку number
            for(var i=0; i<run_list.length; i++){ // заполняем таблицу #run_list_tbody
              if(run_list[i]['starttime'] && !run_list[i]['endtime']){//
                run={'id':run_list[i]['id'],'number':run_list[i]['number']}; // данные активного(текущего) заезда
              }
              run_list_ids["id"+run_list[i]['id']]=i;
            }
            set_html_runlist();
            console.log("END FUNC: get_runs_list");
            return run_list;
        })
    }
    function set_select_bib(){
    /*
    if(!run_list[0].start_list.length)
    alert("func set_select_bib: run_list[0].start_list is empty");
    else
    alert("func set_select_bib: run_list[0].start_list.length="+run_list[0].start_list.length);
    */
    var start_list=race_info.run_list[getObjIDByField(race_info.run_list, "number", 1)].start_list;
    for(var course_id in start_list){ //xxxxxxxxxxxxx
    for(var id in start_list[course_id]){ //xxxxxxxxxxxxx
      $("#src_select_bib").append($('<option>', {
      value: start_list[course_id][id].race_competitor_id,
      text: start_list[course_id][id].bib+" - "+(start_list[course_id][id].ru_lastname?start_list[course_id][id].ru_lastname:start_list[course_id][id].en_lastname)
      }));
    }
    }
    $("#tab_datasrc").append("<button id='btn_src_save' class='btn btn-primary btn-sm'>Save data</button>");
    return true;
    }
    function set_html_runlist(){
      if(!objlen(race_info.run_list)){
        console.log("ERROR: set_html_runlist : race_info.run_list is empty");
        return false;
      }else{
        console.log("init run:",run);
        console.log("CORRECT: set_html_runlist : race_info.run_list.length="+objlen(race_info.run_list));
        var btn='';
        $("#run_list_tbody").html(''); // очищаем таблицу
        for(id in race_info.run_list){ // заполняем таблицу #run_list_tbody
          var btn_start=''; // код кнопки старта/финиша заезда
          var btn_finish=''; // код кнопки старта/финиша заезда
          if(race_info.run_list[id].endtime){ //заезд завершен - ничего
            console.log("finished",race_info.run_list[id].endtime);
            btn_start  = 'style="display:none;"'
            btn_finish = 'style="display:none;"';
          }else if(race_info.run_list[id].starttime){ //заезд начат - завершить заезд
            btn_start  = 'style="display:none;"';
          }else if(!run || !run.id){ // заезд не начат - начать заезд
            btn_finish = 'style="display:none;"';
          }else{ //заезд не начат, есть активный заезд
            btn_start  = 'style="display:none;"'
            btn_finish = 'style="display:none;"';
          }
        console.log("race_info.run_list[id].starttime",race_info.run_list[id].starttime);
        console.log("race_info.run_list[id].endtime",race_info.run_list[id].endtime);
        console.log("btn_finish",btn_finish);
        $("#run_list_tbody").append('\
            <tr class="tr'+id+'">\
              <td class="number">'+race_info.run_list[id].number+'</td>\
              <td class="starttime">'+race_info.run_list[id].starttime+'</td>\
              <td class="endtime">'+race_info.run_list[id].endtime+'</td>\
              <td class="btns">\
                <button class="btn btn-danger btn-sm run_finish" run_id="'+id+'" '+btn_finish+'>Finish</button>\
                <button class="btn btn-primary btn-sm run_start" run_id="'+id+'" '+btn_start+'>Start</button>\
              </td>\
            </tr>');
    }
    $("#run_current").html((run && run.number)?run.number:"нет активных заездов");
    return true;
    }
    }
    // получение стартового списка для заезда run_id
    function get_startlist(run_id=null){
        if(!run_id){
            console.log("START-END FUNC: get_startlist (run.id=null)");
            return race_info.run_list[getObjIDByField(race_info.run_list,"number","1")].start_list; // стартовый список первого заезда
        }else{
            console.log("START FUNC: get_startlist (run.id="+run_id+")");
            return $.get("/raceinfo/startlist/run/"+run_id+"/get/")
            .done(function(data){
                var start_list=JSON.parse(data);
                race_info.run_list[run_id].start_list=start_list;
                console.log("END FUNC: get_startlist (run.id="+run_id+")");
                return start_list;
            });
        }
    }
    function set_html_startlist(run_id){
    console.log("START FUNC: set_html_startlist");
    var j;
    var run=race_info.run_list[run_id];
    //console.log("set_html_startlist(run_id):",(run.start_list))
    if(run.start_list && objlen(run.start_list)){
        for(var course in run.start_list){

          $("#tab_startlist_run"+run_id).append("\
                <table  style='width:100%;' class='course"+course+" table table-bordered'>\
                  <thead>\
                    <tr><th colspan='4'>Course: "+run.courses[course].name+"</th></tr>\
                    <tr>\
                      <th>#</th>\
                      <th class='edit'>New №</th>\
                      <th>bib</th>\
                      <th>Name</th>\
                    </tr>\
                  </thead>\
                  <tbody></tbody>\
                </table>");

          //$("#tab_startlist #tab_startlist_run"+run_id+" table.course"+course+" tbody").html('');
          var j=0;
          for(var cid in run.start_list[course]){
            var comp=run.start_list[course][cid];
            console.log('run.start_list[course][cid]',comp);
            console.log("#tab_startlist #tab_startlist_run"+run_id+" table.course"+course+" tbody");
            $("#tab_startlist #tab_startlist_run"+run_id+" table.course"+course+" tbody").append('\
              <tr class="racecompetitor_'+comp.id+' '+(comp.is_participate?'':'disabled')+'">\
                <td>'+(j+1)+'</td>\
                <td class="edit">\
                  <input type="text" name="'+comp.id+'" value="'+(j+1)+'" style="width:30px;">\
                  <input type="checkbox" id="participate_'+run_id+'_'+comp.id+'" class="participate" data-toggle="toggle" data-size="mini" name="'+comp.id+'" '+(comp.is_participate?'checked':'')+'>\
                </td>\
                <td>'+comp.bib+'</td>\
                <td>'+comp.ru_lastname+' '+ comp.ru_firstname+' / '+comp.en_lastname+' '+ comp.en_firstname+'</td>\
              </tr>\
              ');
              j++;
          }
          $(function() {
              $("#tab_startlist #tab_startlist_run"+run_id+" table.course"+course+" tbody tr td.edit .participate").bootstrapToggle();
          })
          //кнопка редактирования стартового списка
          if(!$("#tab_startlist #tab_startlist_run"+run_id+" .btn_edit_startlist").length){
              $("#tab_startlist #tab_startlist_run"+run_id).append("<button value='' class='btn btn-primary btn-sm btn_edit_startlist' run_id='"+run_id+"'>edit</button>");

              if(run.number&&run.number>1)
                $("#tab_startlist #tab_startlist_run"+run_id).append("<button value='' class='btn btn-primary btn-sm btn_reverse_startlist' run_id='"+run_id+"'>reverse top 15</button>");

              $("#tab_startlist #tab_startlist_run"+run_id).append("\
                <div class='edit_btns'>\
                All:\
                <button value='all' class='btn btn-info btn-sm btn_startlist_on' run_id='"+run_id+"'>On</button>\
                <button value='' class='btn btn-default btn-sm btn_startlist_on' run_id='"+run_id+"'>Off</button>\
                Turn on first:\
                <button value='15' class='btn btn-default btn-sm btn_startlist_on' run_id='"+run_id+"'>15</button>\
                <button value='30' class='btn btn-default btn-sm btn_startlist_on' run_id='"+run_id+"'>30</button>\
                <button value='45' class='btn btn-default btn-sm btn_startlist_on' run_id='"+run_id+"'>45</button>\
                <br><hr>\
                </div>\
                <button value='' class='btn btn-danger btn-sm btn_save_startlist' run_id='"+run_id+"'>save</button>\
                <button value='' class='btn btn-defaul btn-sm btn_canceledit_startlist' run_id='"+run_id+"'>cancel</button>\
                ");
              $("#tab_startlist #tab_startlist_run"+run_id+" .edit_btns").hide();
              $("#tab_startlist #tab_startlist_run"+run_id+" .btn_save_startlist").hide();
              $("#tab_startlist #tab_startlist_run"+run_id+" .btn_canceledit_startlist").hide();
          }
        }
      }
    $("#tab_startlist #tab_startlist_run"+run_id+" table .edit").hide();

    console.log("END FUNC: set_html_startlist");
    }

    /*
    * Functions
    */
    //подготовка таба со стартовыми списками по заездам (#tab_startlist)
    function startlist_tab_prepare(){
      console.log("startlist_tab_prepare",race_info);
      if(objlen(race_info.run_list)){
        $("#tab_startlist").html("");
        $("#tab_startlist").append("<h2>Start lists</h2>");
        for(id in race_info.run_list){
        //$.each(race_info.run_list, function(value){
          $("#tab_startlist").append("<div id='tab_startlist_run"+id+"'></div>");
          $("#tab_startlist_run"+this.id).append("<h3>Заезд "+race_info.run_list[id].number+"</h3>");
          if(!race_info.run_list[id].starttime)
              $("#tab_startlist_run"+id).append("<b>Статус: <span class='status'>не начат</span></b><br>");
          else if(!race_info.run_list[id].endtime)
              $("#tab_startlist_run"+id).append("<b>Статус: <span class='status'>активен</span></b><br>");
          else
              $("#tab_startlist_run"+id).append("<b>Статус: <span class='status'>завершен</span></b><br>");
          if(race_info.run_list[id].starttime){
            console.log("set_html_startlist(id);",id);
            set_html_startlist(id);
          }
        }
        if(!run.id && !race_info.run_list[Object.keys(race_info.run_list)[0]].starttime){ // если нет активного рана, и первый ран еще не был начат
            console.log("set_html_startlist(null);");
            set_html_startlist(Object.keys(race_info.run_list)[0]);
        }
      }else{
        alert("runlist error");
      }
    }
    // получение и внесение информации для вкладки "Устройства на трассах" (#tab_device)
    function courselist_tab_prepare(){
      if(course_list.length){
        $("#tab_device").append("<h2>Устройства на трассах</h2>");
        for(var i=0;i<course_list.length;i++){
          //console.log(this);
          $("#tab_device").append("<h3>Course "+course_list[i].id+" (runs: "+course_list[i].runs_str.join(", ")+")</div>");
          $("#tab_device").append("<table id='device_course_"+course_list[i].id+"' style='width:100%;' class='table table-bordered'><thead><tr><th>id</th><th class='edit'>№</th><th>distance</th><th>Type</th><tr></thead><tbody></tbody></table>");
          // получаем список девайсов для трассы this.id
          return $.get("/raceinfo/device/get/course/"+course_list[i].id)
          .done(function(data){
            var dev_list=JSON.parse(data);
            device_list["course_"+dev_list[0][0].course_id]=dev_list;
            $.each(dev_list, function(value) {
              $("#device_course_"+this[0].course_id+" tbody").append("<tr><td>"+ this[1].id+"</td><td>"+this[0].order+"</td><td>"+this[0].distance+"</td><td>"+this[1].name+"</td>");
            });
            console.log("FUNC: courselist_tab_prepare - device_list ready");
            //prepare_result_tables();
            return device_list;
          })
        }
      }else{
        alert("courselist error");
        return false;
      }
    }

    // формирование список трасс (course) с заездами (runs) на них
    function courselist_get(){
      var cid_prev=null;
      for(var i=0; i<run_list.length; i++){
        if(run_list[i].course_id!=cid_prev){
          course_list.push({"id":run_list[i].course_id, "runs":Array(), "runs_str":Array(), "dev":""});
        }
        course_list[course_list.length-1].runs.push({"id":run_list[i].id, "number":run_list[i].number});
        course_list[course_list.length-1].runs_str.push(run_list[i].number);
        cid_prev=run_list[i].course_id;
      }
      return course_list;
    }
    function prepare_result_tables(){
      $.each(race_info.run_list, function(run_id,run_arr){
        prepare_result_tables_for_run(run_id,run_arr);
      });
    }

    function prepare_result_tables_for_run(run_id, run_arr=null){
      if(!run_arr)
        var run_arr=race_info.run_list[run_id];
        thead[run_id]={};

        console.log("PREPARE_RESULT_TABLES: run_id:"+run_id);
        console.log("run_arr", run_arr);


        if(!$("#tab_summarytable .div_run"+run_id).length){
          $("#tab_summarytable").append("<div class='div_run"+run_id+"'>\
              <h3>Run: "+((run_arr.number)?run_arr.number:" Forerunners")+"</h3>\
              </div>");
          for(var course in run_arr.courses){
            var d = run_arr.courses[course].devices;
            var width = 100/objlen(d);
            $("#tab_summarytable div.div_run"+run_id).append("\
              <table style='width:100%;' class='table table-bordered run"+run_id+"_course"+course+"'>\
                <thead>\
                  <tr>\
                    <th colspan='"+(objlen(d)+1)+"'>Course: "+run_arr.courses[course].name+"</th>\
                  </tr><tr>\
                    <th class='row1' colspan='"+(objlen(d)+1)+"'>\
                      <div class='bib'>bib</div>\
                      <div class='name'>Name</div>\
                      <div class='rank'>Rank</div>\
                      <div class='time'>Time</div>\
                      <div class='status'>Status</div>\
                      <div class='btns'></div>\
                    </th>\
                  </tr>\
                </thead>\
                <tbody></tbody>\
              </table>\
            </div>");
            $.each(d, function(idx,dev){
              //console.log("dev",dev);
              thead[run_id][course]+="<th style='width:"+width+"%'>"+dev.type+" - "+dev.distance+(dev.order>1?"<br>Sector "+(dev.order-1):"")+"</th>";
            });
          }
        }

      return true;
    }
    function refresh_status(run_id,comp_id,status_id){
      console.log("START: refresh_status "+"#tab_manualcontrol tr.tr_"+run_id.replace("run","")+"_"+comp_id.replace("comp_","")+" td.status");
      $("#tab_manualcontrol tr.tr_"+run_id.replace("run","")+"_"+comp_id.replace("comp_","")+" td.status").html(getObjById(status_list,"id",status_id).name);
      if(status_id){
        if(status_id==1)$("#tab_manualcontrol tr.tr_"+run_id.replace("run","")+"_"+comp_id.replace("comp_","")).removeClass("danger").addClass("success");
        else $("#tab_manualcontrol tr.tr_"+run_id.replace("run","")+"_"+comp_id.replace("comp_","")).removeClass("danger").addClass("warning");

        $("#tab_manualcontrol tr.tr_"+run_id.replace("run","")+"_"+comp_id.replace("comp_","")+" button.btn_start").hide();
      }else{
        $("#tab_manualcontrol tr.tr_"+run_id.replace("run","")+"_"+comp_id.replace("comp_","")+" button.btn_start").show();
      }
    }
    function set_current_data(){
      console.log("set_current_data - START");
      if(objlen(glob_arr)){
        console.log("set_current_data - START - glob_arr");
        var kkey, ckey;
        for(rkey in glob_arr){
          for(ckey in glob_arr[rkey]){
            if(glob_arr[rkey][ckey]){
              sumtab_set_maininfo(glob_arr[rkey][ckey]);
              refresh_status(rkey,ckey,glob_arr[rkey][ckey].status_id);
            }else{
              console.log("call:cleared_competitor");
              cleared_competitor(rkey,ckey);
            }
          }
          if(!glob_arr[rkey]){
            //чистим данные в таблице
            $("#tab_summarytable table.table_run1 tbody tr").remove();
          }
        }
      }else{
        // нет текущих данных
        console.log("ERROR: set_current_data: glob_arr.length is false");
      }
    }
    function cleared_competitor(rkey,ckey){
        $("#tab_summarytable .div_"+rkey+" tr[class*='"+ckey+"_']").remove();
        refresh_status(rkey,ckey);
        $("#tab_manualcontrol tr.tr_"+rkey.replace("run","")+"_"+ckey.replace("comp_","")+" button.btn_start").show();
        console.log("cleared_competitor("+rkey+","+ckey+"): #tab_manualcontrol tr.tr_"+rkey.replace("run","")+"_"+ckey.replace("comp_","")+" button.btn_start");
        console.log("#tab_summarytable .div_"+rkey+" tr[class*='"+ckey+"_']");
        return true;
    }
    function add2datasrc(data){
      //      $("#tab_data_src tbody").append("<tr class='datasrc_"+data[0].id+"'><td>"+data[3].course_id+"</td><td>"+data[3].device_id+(data[3].is_start?" - start":" -"+data[3].distance)+"</td><td>"+data[0].absolut_time+"</td><td>"+data[0].time+"</td><td>"+data[1].bib+"</td><td>"+data[2].en_firstname+" "+data[2].en_lastname +" / " + data[2].ru_lastname+" "+data[2].ru_firstname+"</td><td class='act'></td></tr>")
      console.log("add2datasrc");
      //console.log("data[0].id="+data[0].id);
      console.log(data);
      var name_str=(data[3]?data[3].en_firstname+" "+data[3].en_lastname +" / " + data[3].ru_lastname+" "+data[3].ru_firstname:"");
      if ($("#tab_data_src tbody tr.datasrc_"+data[0].id).length == 0) {
        //Add it to the dom
        $("#tab_data_src tbody").append("<tr class='datasrc_"+data[0].id+(data[2]?"":" warning")+"'><td>"+data[0].run_id+"</td><td>"+data[4].course_id+"</td><td>"+data[4].device_id+"</td><td>"+dtform(data[0].time)+"</td><td class='bib'>"+(data[2]?data[2].bib:"")+"</td><td class='name'>"+name_str+"</td><td class='act'><div class='div_select_bib_"+((data[1])?data[1].id:null)+"'></div></td></tr>");
      }else{
        $("#tab_data_src tbody tr.datasrc_"+data[0].id).addClass("danger");
        $("#tab_data_src tbody tr.datasrc_"+data[0].id+" td.bib").append("<div>"+(data[2]?data[2].bib:"")+"</div>");
        $("#tab_data_src tbody tr.datasrc_"+data[0].id+" td.name").append("<div>"+name_str+"</div>");
        $("#tab_data_src tbody tr.datasrc_"+data[0].id+" td.act").append("<div class='div_select_bib_"+((data[1])?data[1].id:null)+"'></div>");
      }
      $("#src_select_bib").clone()
        .attr({"id": "src_select_bib_"+data[0].id+"_"+((data[1])?data[1].id:null),
               "result_detail_id": data[1]?data[1].id:null, //my
               "data_in_id": data[0].id,
               "run_id": data[0].run_id})
        .appendTo("tr.datasrc_"+data[0].id+" td.act div.div_select_bib_"+((data[1])?data[1].id:null));
    }
    // проверка текущего состония спортсмена и можно ли его переводить на старт/финиш/апрув/clear - используем при нажатии на кнопки
    function set_comp_status(competitor_id, state ,run_id){
      var err="";
      if(!comp_state["run_"+run_id])comp_state["run_"+run_id]=new Array();

        if(state=="start"){
          if(!comp_state["run_"+run_id]["comp_"+competitor_id])
            comp_state["run_"+run_id]["comp_"+competitor_id]="start";
          else if(comp_state["run_"+run_id]["comp_"+competitor_id]=="start")
            err = "error - can't start because has already started";
          else if(comp_state["run_"+run_id]["comp_"+competitor_id]=="finish")
            err = "error - can't start because has already finished";
          else if(comp_state["run_"+run_id]["comp_"+competitor_id]=="approve")
            err = "error - can't start because has been already approved";
          else if(comp_state["run_"+run_id]["comp_"+competitor_id]=="manual_approve")
            err = "error - can't start because has been approved manualy";
        }

        if(state=="finish"){
          if(!comp_state["run_"+run_id]["comp_"+competitor_id])
            err = "error - can't finish because hasn't started";
          else if(comp_state["run_"+run_id]["comp_"+competitor_id]=="finish")
            err = "error - can't finish because already has finished";
          else if(comp_state["run_"+run_id]["comp_"+competitor_id]=="approve")
            err = "error - can't finish because already has been approved";
          else if(comp_state["run_"+run_id]["comp_"+competitor_id]=="manual_approve")
            err = "error - can't finish because already has been approved manualy";
          else
            comp_state["run_"+run_id]["comp_"+competitor_id]="finish";
        }

        if(state=="approve"){
            comp_state["run_"+run_id]["comp_"+competitor_id]="approve";

        }

        if(state=="manual_approve"){
            comp_state["run_"+run_id]["comp_"+competitor_id]="manual_approve";
        }

        if(state=="clear"){
            comp_state["run_"+run_id]["comp_"+competitor_id]=false;
        }

        if(err){
          alert(err);
          return false;
        }else
          return true;
    }
    function set_list_for_manualcontrol(){
      console.log("START FUNC: set_list_for_manualcontrol");
      var flag_started_run=false; //флаг, указывающий, что у нас есть хотя бы 1 начатый заезд


      if(objlen(race_info.run_list)>0){
        //var run={"id":null,"number":null};
        for(var id in race_info.run_list){
          if(race_info.run_list[id].starttime){
            flag_started_run=true;
            //run.id=id;
            //run.number=run_list[id].number;
            console.log(race_info.run_list[id].start_list);
            if(race_info.run_list[id].start_list && objlen(race_info.run_list[id].start_list)){
              $("#tab_manualcontrol tbody tr.empty_run").remove();
              $("#tab_manualcontrol tbody").append("\
                <tr class='tr_"+id+"'>\
                  <td colspan='"+(objlen(race_info.run_list[id].start_list))+"'>Run: "+race_info.run_list[id].number+" (#"+id+")"+"</td>\
                </tr>\
                <tr class='courses'></tr>");
              for(var course in race_info.run_list[id].start_list){
                $("#tab_manualcontrol tbody tr.courses").append("\
                  <td class='run"+id+"_course"+course+"'>\
                    Course: "+race_info.run_list[id].courses[course].name+" (#"+course+")"+"\
                    <table class='tab_run"+id+"_course"+course+" table table-hover'>\
                    <thead>\
                      <tr>\
                          <th>№</th>\
                          <th>bib</th>\
                          <th>Name</th>\
                          <th align='center'>Status</th>\
                          <th align='center' colspan='3'>Controls</th>\
                      </tr>\
                    </thead>\
                    <tbody></tbody>\
                    </table>\
                  </td>");
                $.each(race_info.run_list[id].start_list[course], function(value){
                  var competitor_id=this.race_competitor_id;
                  var btn_start="<button class='btn btn-primary btn-sm btn_start' competitor_id='"+competitor_id+"' course_id='"+course+"' run_id='"+id+"'>Start</button>";
                  var btn_finish="";//"<button class='btn btn-success btn-sm btn_finish' competitor_id='"+competitor_id+"' run_id='"+run.id+"'>Finish</button>";

                  var btn_approveqlf="";//<button class='btn btn-defaul btn-sm btn_approveqlf' competitor_id='"+competitor_id+"' run_id='"+run.id+"'>Approve QLF</button>";
                  var btn_editresult="<button class='btn btn-defaul btn-sm btn_editresult' competitor_id='"+competitor_id+"' course_id='"+course+"' run_id='"+id+"'>Edit</button>";

                  var btn_clearresult="<button class='btn btn-danger btn-sm btn_clear' competitor_id='"+competitor_id+"' course_id='"+course+"' run_id='"+id+"'>Clear</button>";

                  $("#tab_manualcontrol tbody table.tab_run"+id+"_course"+course+" tbody").append("\
                      <tr class='tr_"+competitor_id+"'>\
                      <td class='order'>"+this.order+"</td>\
                      <td>"+this.bib+"</td>\
                      <td>"+getCompNameBR(this)+"</td>\
                      <td class='status'></td>\
                      <td>"+btn_start+btn_finish+"</td>\
                      <td>"+btn_approveqlf+btn_editresult+"</td>\
                      <td>"+btn_clearresult+"</td></tr>");
                });
              }
            }else{
              console.log("ERROR! set_list_for_manualcontrol: objlen(race_info.run_list["+id+"].start_list) is false");
            }
            console.log("END FUNC: set_list_for_manualcontrol");
          }
        }//end for
        if(!flag_started_run){
          $("#tab_manualcontrol tbody").append("<tr class='empty_run'><td class='order' colspan='"+(objlen(race_info.run_list[id].start_list))+"'>Ни один заезд не начат</td></tr>");
          return false;
        }
      }//end if
    } //end function

    //получаем
    function get_active_run(race_list){
      for(id in race_list){
        console.log("get_active_run - "+id,race_list);
        if(race_list[id].starttime && !race_list[id].endtime)
          return {"id":id, "number":race_list[id].number};
      }
      return {"id":null,"number":null};
    }
    //форматирование чисел
    function nform(v){
      return number_format(v, 4, '.', ' ');
    }
    //форматирование времени
    function tform(v){
      var sss=v%1000;
      var str_sss="";

      str_sss=sss;
      if(sss<100) str_sss="0"+str_sss;
      if(sss<10)  str_sss="0"+str_sss;

      var ss=Math.floor(v/1000)%60; //((v-v%1000)/1000)%60;
      if(ss<10)ss="0"+ss;

      var mm=Math.floor(v/60000) //(v-(ss*1000+ssss))/60/1000;
      if(mm<10)mm="0"+mm;
      return mm+":"+ss+"."+str_sss;
    }
    //форматирование времени
    function dtform(v){
      return moment(v).format('DD.MM.YYYY HH:mm:ss.SSSS');
    }
    function number_format(number, decimals, dec_point, thousands_sep) {
        number = (number + '').replace(/[^0-9+\-Ee.]/g, '');
        var n = !isFinite(+number) ? 0 : +number,
            prec = !isFinite(+decimals) ? 0 : Math.abs(decimals),
            sep = (typeof thousands_sep === 'undefined') ? ',' : thousands_sep,
            dec = (typeof dec_point === 'undefined') ? '.' : dec_point,
            s = '',
            toFixedFix = function (n, prec) {
                var k = Math.pow(10, prec);
                return '' + Math.round(n * k) / k;
            };
        s = (prec ? toFixedFix(n, prec) : '' + Math.round(n)).split('.');
        if (s[0].length > 3) {
            s[0] = s[0].replace(/\B(?=(?:\d{3})+(?!\d))/g, sep);
        }
        if ((s[1] || '').length < prec) {
            s[1] = s[1] || '';
            s[1] += new Array(prec - s[1].length + 1).join('0');
        }
        return s.join(dec);
    }
    // формирует строку с именами спортсменров
    function getCompName(obj){
      console.log("obj",obj);
      return obj.en_firstname+" "+obj.en_lastname+" / "+obj.ru_lastname+" "+obj.ru_firstname +"(#"+obj.race_competitor_id+")";
    }
    function getCompNameBR(obj){
      console.log("obj",obj);
      return obj.en_firstname+" "+obj.en_lastname+"</br>"+obj.ru_lastname+" "+obj.ru_firstname +"<br>(#"+obj.race_competitor_id+")";
    }

    // обертка для промисов (пока не знаю, как сделать лучше)
    function socket_emit(s, obj){
        console.log(s,obj);
        socket.emit(s, obj);
    }
    function socket_emit_emptyobj(s){
        console.log("socket_emit_emptyobj",s);
        socket.emit(s);
    }
    // getstatusById
    function getObjById(arr,prop,val){
        for(var idx = 0; idx<arr.length;idx++)
          if(arr[idx] && arr[idx][prop] == val) return arr[idx];
        return false;
    }
    // ищет в obj объект с полем prop==val, возвращает ключ объекта
    function getObjIDByField(obj,prop,val){
        for(id in obj)
          if(obj[id][prop]==val)
            return id;
    }
    // кол-во элементов в объексте
    function objlen(obj){
        return Object.keys(obj).length?Number(Object.keys(obj).length):false;
    }

    // возвращает cookie с именем name, если есть, если нет, то undefined
    function getCookie(name) {
      var matches = document.cookie.match(new RegExp(
        "(?:^|; )" + name.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g, '\\$1') + "=([^;]*)"
      ));
      return matches ? decodeURIComponent(matches[1]) : null;
    }
    function setCookie(name, value, options) {
      options = options || {};

      var expires = options.expires;

      if (typeof expires == "number" && expires) {
        var d = new Date();
        d.setTime(d.getTime() + expires * 1000);
        expires = options.expires = d;
      }
      if (expires && expires.toUTCString) {
        options.expires = expires.toUTCString();
      }

      value = encodeURIComponent(value);

      var updatedCookie = name + "=" + value;

      for (var propName in options) {
        updatedCookie += "; " + propName;
        var propValue = options[propName];
        if (propValue !== true) {
          updatedCookie += "=" + propValue;
        }
      }

      document.cookie = updatedCookie;
    }


///////////////////////
$(document).ready(function () {

    Promise.all([get_race_list()])
    .then(
          result=>get_status_list(),
          error=>alert("[eqyz]")
    ).then(
          result=>socket_emit('GetRaceInfo',{'race_id': race_id})//socket.emit('get/results', {run_id: 1}) //result=>get_current_data(race_id)
    );

    $("body").on("click", ".nav nav-tabs li", function () {
      document.cookie = "tab="+$(this).id;
    });
    $("body").on("click","#btn_frunners_start",function(){
      $.ajax({
        url:"/raceinfo/race/"+race_id+"/run/forerunners/build",
        success: function(data) {
            data = JSON.parse(data);
            console.log(data);
            alert('success: '+data);
        },
        error: function(data) {
            data = JSON.parse(data);
            console.log(data);
            alert('error: '+data);
        }
      });
    });
    $("body").on("click","#btn_frunners_stop",function(){
      $.ajax({
        url:"/raceinfo/race/"+race_id+"/run/forerunners/del",
        success: function(data) {
            console.log(data);
            alert('success: '+data);
        },
        error: function(data) {
          console.log(data);
            alert('error: '+data);
        }
      });
    });
    $("body").on("click", "#btn_ScoreBoardConnect", function () {
      socket.emit("ScoreboardConnect");
    });
    $("body").on("click", "#ScoreBoardSwitcher", function () {
      $.ajax({
        url:"/raceinfo/scoreboard/status",
        success: function(data) {
            console.log(data);
            alert('success: '+data);
        },
        error: function(data) {
          console.log(data);
            alert('error: '+data);
        }
      });
    });
    // обработка кнопки - подтверждение заезда спортсмена со статусом QLF
    $("body").on("click", ".approveQLF", function () {
      $.ajax({
        url: "/raceinfo/approve/run/"+$(this).attr('run_id')+"/competitor/"+$(this).attr('competitor_id'),
        //dataType: 'json',
        data: {
          data: JSON.stringify({
            'absolut_time':$(this).attr('absolut_time')}
          )},
        success: $.proxy(function(json) {
            //console.log("#action"+$(this).attr('run_id')+"_"+$(this).attr('competitor_id'));
            $("#action"+$(this).attr('run_id')+"_"+$(this).attr('competitor_id')).html("Approved");
        }, this),
          /*success:function(data) {
            console.log("#action"+$(this).attr('run_id')+"_"+$(this).attr('run_id'));
            $("#action"+$(this).attr('run_id')+"_"+$(this).attr('run_id')).html("Approved");
          },*/
          error: function (error) {alert('error'); }
      });
    });
    // обработка кнопки финиш заезда
    $("body").on("click", ".run_finish", function () {
      var cid = $(this).attr('run_id');
      $.ajax({
        type: "GET",
        url: "/raceinfo/race/"+race_id+"/run/"+cid+"/stop",
        success: function(data) {
          data=JSON.parse(data);
          console.log("data",data);
          console.log(".tr"+cid);
          if(data.stop_time){
            // run - текущий активный заезд
            run.id=false;
            run.number=false;

            // меняем данные для заезда в объекте гонки
            race_info.run_list[cid].endtime=data.stop_time;

            // меняем данные для заезда в таблице заездов
            $("#run_list_tbody tr.tr"+cid+" td.endtime").html(data.stop_time);
            var next_run=getObjIDByField(race_info.run_list, "number", race_info.run_list[cid].number+1);
            if(next_run)$("#run_list_tbody tr.tr"+next_run+" td.btns .run_start").show();
            $("#run_list_tbody tr.tr"+cid+" td.btns .run_start").hide();
            $("#run_list_tbody tr.tr"+cid+" td.btns .run_finish").hide();


            // меняем статус заезда во вкладке "стартовые листы"
            $("#tab_startlist_run"+cid+" .status").html("завершен");
          }else{
            add_error({"msg":"При остановке заезда сервер вернул false","data":data});
          }
          //Promise.all([get_runs_list()]).then(result=>runinfo_get());
          //runinfo_get();
        }
      });
    });
    // обработка кнопки старт заезда
    $("body").on("click", ".run_start", function () {
      var cid = $(this).attr('run_id');
      $.ajax({
        type: "GET",
        url: "/raceinfo/race/"+race_id+"/run/"+cid+"/start",
        success: function(data) {
          data=JSON.parse(data);
          console.log(data);
          if(data.success){
            // run - текущий активный заезд
            run.id=cid;
            run.number=race_info.run_list[cid].number;

            // меняем данные для заезда в объекте гонки
            race_info.run_list[cid].start_time=data.starttime;
            console.log("#run_list_tbody .tr"+cid+" .starttime",data.starttime);
            // меняем данные для заезда в таблице заездов
            $("#run_list_tbody .tr"+cid+" .starttime").html(data.starttime);
            $("#run_list_tbody .tr"+cid+" td.btns .run_start").hide();
            $("#run_list_tbody .tr"+cid+" td.btns .run_finish").show();

            // меняем статус заезда во вкладке "стартовые листы"
            $("#tab_startlist_run"+cid+" .status").html("Активен");
          }else{
            add_error({"msg":"При остановке заезда сервер вернул false","data":data});
          }

          Promise.all([get_startlist(cid)])
          .then(result=>startlist_tab_prepare(cid))
          .then(result=>set_list_for_manualcontrol());

          /*
          Promise.all([get_runs_list()])
            .then(result=>runinfo_get())
            .then(result=>get_startlist(cid))
            .then(result=>set_list_for_manualcontrol());
          $("#tab_startlist_run"+cid+" .status").html("активен");
          */

          //  add_result_table($(this).attr('run_id')); // создаем таблицу для общих результатов. !!!к этому моменту должны быть уже получены все массивы run_list, course_list, dev_list
        }
      });
    });
    // обработка кнопки вызова ручного ввода результата - модальное окно #popup_editresult
    $("body").on("click", ".editresult", function () {
      console.log($(this).attr('run_id'));
      $("#form_txt_competitor").html($(this).attr('competitor_id'));
      console.log("num="+run_list[run_list_ids["id"+$(this).attr('run_id')]].number);
      $("#form_txt_run").html(run_list[run_list_ids["id"+$(this).attr('run_id')]].number);

      $("#form_run_id").val($(this).attr('run_id'));
      $("#form_competitor_id").val($(this).attr('competitor_id'));

      $("#popup_editresult").modal('show');
    });

    $("body").on("click", ".editform_approve", function () {
        var obj={
          'run_id' : $("#form_run_id").val(),
          'competitor_id' : $("#form_competitor_id").val(),
          'status_id' : $("#form_status").val(),
          'finish_time' : $("#form_finishtime").val()?$("#form_finishtime").val():false,
          'start_time' : $("#form_starttime").val()?$("#form_starttime").val():false,
          'reason' : $("#form_reason").val(),
          'gate' : $("#form_gate").val()
          //'course_id': race_info.run_list[$("#form_run_id").val()].courses[].course_id
        };
        console.log("obj",obj);
        socket.emit('CompetitorManualApprove', obj);
        /*
        $.ajax({
          type: "GET",
          url: "/raceinfo/approve/edit/run/"+$("#form_run_id").val()+"/competitor/"+$("#form_competitor_id").val(),
          //dataType: 'json',
          data: {
            data: JSON.stringify({
              'start_time':  stime,
              'finish_time': ftime,
              'reason': $("#form_reason").val(),
              'gate': $("#form_gate").val(),
              'status_id':  $("#form_status").val(),
              'course_id': run_list[run_list_ids["id"+$("#form_run_id").val()]].course_id
            })
          },
          success:function(data) {
            console.log("editform_approve:success");
            $("#action"+$("#form_run_id").val()+"_"+$("#form_competitor_id").val()).html("Approved");
            $("#popup_editresult").modal('hide');
            get_current_data(race_id);
          },
          error: function (error) {
            console.log("editform_approve:error");
            alert('error');
          }
        })
        */
    });

    // обработка кнопки выхова редактирования стартлиста
    $("body").on("click", ".btn_edit_startlist", function () {
        var r=$(this).attr('run_id');
        $("#tab_startlist_run"+r+" table .edit").show();
        $("#tab_startlist_run"+r+" table .edit").show();

        $("#tab_startlist_run"+r+" .btn_edit_startlist").hide();
        $("#tab_startlist_run"+r+" .btn_save_startlist").show();
        $("#tab_startlist_run"+r+" .edit_btns").show();
        $("#tab_startlist_run"+r+" .btn_canceledit_startlist").show();
    });
    // обработка кнопки выхова редактирования стартлиста
    $("body").on("click", ".btn_reverse_startlist", function () {
        var r=$(this).attr('run_id');
        $.ajax({
          type: "GET",
          url: "/raceinfo/race/"+race_id+"/run/"+r+"/order_list/revers",
          success:function(data) {
            Promise.all([get_startlist(r)]).then(
                  result=>get_startlist(r)
            );
            //console.log("set_html_startlist("+r+");");
          },
            error: function (error) {
            alert("error: save start list fro run"+r);
          }
        })
    });
    // обработка кнопки отмены редактирования стартлиста
    $("body").on("click", ".btn_startlist_on", function () {
      var r=$(this).attr('run_id');
      console.log($(this).val);
      if($(this).attr('value')=="all")
        $("#tab_startlist_run"+r+" table .edit .participate").bootstrapToggle('on')
      else if($(this).attr('value')=="")
          $("#tab_startlist_run"+r+" table .edit .participate").bootstrapToggle('off')
      else{
        var n=$(this).attr('value');
        var arr=$("#tab_startlist_run"+r+" table .edit .participate");
        $("#tab_startlist_run"+r+" table .edit .participate").bootstrapToggle('off')
        for(var i=0;i<n;i++)
          $($("#tab_startlist_run"+r+" table .edit .participate")[i]).bootstrapToggle('on');
      }
    });

    // обработка кнопки отмены редактирования стартлиста
    $("body").on("click", ".btn_canceledit_startlist", function () {
      var r=$(this).attr('run_id');
      $("#tab_startlist_run"+r+" table .edit").hide();
      $("#tab_startlist_run"+r+" table .edit").hide();

      $("#tab_startlist_run"+r+" .btn_edit_startlist").show();
      $("#tab_startlist_run"+r+" .btn_save_startlist").hide();
      $("#tab_startlist_run"+r+" .edit_btns").hide();
      $("#tab_startlist_run"+r+" .btn_canceledit_startlist").hide();
    });
    // обработка кнопки сохнанения изменений в стартлисте
    $("body").on("click", ".btn_save_startlist", function () {
        var r=$(this).attr('run_id');
        var arr = [];
        $("#tab_startlist_run"+r+" table .edit input[type='text']").each(function() {
          arr.push([this.name, parseInt(this.value), $("#participate_"+r+"_"+this.name).prop('checked')]);
        });
        if(arr.length){
          console.log("sort");
          arr.sort(function(a,b){if (a[1] > b[1]) return 1; else if (a[1] < b[1]) return -1; else return 0;}); // сортируем список по новому порядку order
          console.log(arr);
          for(var i=0;i<arr.length;i++){
            arr[i][1]=i+1;
          }
          console.log(arr);

          $.ajax({
            type: "GET",
            url: "/raceinfo/race/order_list/edit",
            //dataType: 'json',
            data: {
              data: JSON.stringify({
                'run_id': r,
                'order_list': arr
              })
            },
            success:function(data) {
            //  startlist_get(r);
              //alert("Start list has been changed ");
              $("#tab_startlist_run"+r+" table .edit").hide();

              $("#tab_startlist_run"+r+" .btn_edit_startlist").show();
              $("#tab_startlist_run"+r+" .btn_save_startlist").hide();
              $("#tab_startlist_run"+r+" .edit_btns").hide();
              $("#tab_startlist_run"+r+" .btn_canceledit_startlist").hide();
              Promise.all([get_startlist(r)]).then(
                    result=>get_startlist(r)
              );
              //console.log("set_html_startlist("+r+");");
            },
            error: function (error) {
              alert("error: save start list fro run"+r);
            }
          })
        }
    });
    //---------------------------------
    $("body").on("click", ".btn_start", function () {
      var run_id=$(this).attr('run_id');
      var competitor_id=$(this).attr('competitor_id');
      $.ajax({
        type: "GET",
        url: "/raceinfo/run/competitor/start",
        data:({
          'run_id': run_id,
          'competitor_id': competitor_id
        }),
        success:function(data) {
          if(set_comp_status(competitor_id, "start" ,run_id)){
            var status_name = "On Start";
            console.log('start competitor - run:'+run_id+' competitor:'+competitor_id);
            tab_summarytable_set_status(run_id,competitor_id,status_name,false);
            $("#tab_manualcontrol tr.tr_"+run_id+"_"+competitor_id+" .status").html(status_name);
          }
        },
        error: function(error) {
          alert('error - start competitor run:'+run_id+' competitor:'+competitor_id);
        }
      });
    });
    $("body").on("click", ".btn_finish", function () {
      var run_id=$(this).attr('run_id');
      var competitor_id=$(this).attr('competitor_id');
      $.ajax({
        type: "GET",
        url: "/raceinfo/run/competitor/finish",
        data:({
          'run_id': run_id,
          'competitor_id': competitor_id
        }),
        success:function(data) {
          if(set_comp_status(competitor_id, "finish" ,run_id)){
            console.log('finish competitor - run:'+run_id+' competitor:'+competitor_id);
            $("#tab_manualcontrol tr.tr_"+run_id+"_"+competitor_id+" .status").html("finished");
            $("#tab_manualcontrol tr.tr_"+run_id+"_"+competitor_id).removeClass("danger");
            $("#tab_manualcontrol tr.tr_"+run_id+"_"+competitor_id).addClass("warning");
            //$("#tab_manualcontrol tr .btn_start").prop('disabled',false);
            //("#tab_manualcontrol .btn_finish").prop('disabled',true);
          }
        },
        error: function(error) {
          alert('error - end competitor run:'+run_id+' competitor:'+competitor_id);
        }
      });
    });
    $("body").on("click", ".btn_approveqlf", function () {
      var run_id=$(this).attr('run_id');
      var competitor_id=$(this).attr('competitor_id');
      $.ajax({
        type: "GET",
        url: "/raceinfo/approve/run/"+run_id+"/competitor/"+competitor_id,
        data:({
        }),
        success:function(data) {
          if(set_comp_status(competitor_id, "approve" ,run_id)){
            console.log('approve competitor - run:'+run_id+' competitor:'+competitor_id);
            $("#tab_manualcontrol tr.tr_"+run_id+"_"+competitor_id+" .status").html("approved");
            $("#tab_manualcontrol tr.tr_"+run_id+"_"+competitor_id).removeClass("danger");
            $("#tab_manualcontrol tr.tr_"+run_id+"_"+competitor_id).removeClass("warning");
            $("#tab_manualcontrol tr.tr_"+run_id+"_"+competitor_id).addClass("success");
            //$("#tab_manualcontrol tr.tr_"+run_id+"_"+competitor_id+" .btn").prop('disabled',true);
            $("#tab_manualcontrol tr.tr_"+run_id+"_"+competitor_id+" .btn").hide();
          }
        },
        error: function(error) {
          alert('error - approve competitor run:'+run_id+' competitor:'+competitor_id);
        }
      });
    });
    $("body").on("click", ".btn_editresult", function () {
      var run_id=$(this).attr('run_id');
      var course_id=$(this).attr('course_id');
      var competitor_id=$(this).attr('competitor_id');
      var dev_arr=race_info.run_list[run_id].courses[course_id].devices;

      var dev_start=dev_arr[0].id;
      var dev_finish=dev_arr[dev_arr.length-1].id;

      var start_time=$("#tab_summarytable table.run"+run_id+"_course"+course_id+" tr.comp_"+competitor_id+"_absoluttime td.dev_"+dev_start).html();
      var finish_time=$("#tab_summarytable table.run"+run_id+"_course"+course_id+" tr.comp_"+competitor_id+"_absoluttime td.dev_"+dev_finish).html();

      var reason=$("#tab_summarytable table.run"+run_id+"_course"+course_id+" tr.comp_"+competitor_id+"_dsq .reason").html();
      var gate = $("#tab_summarytable table.run"+run_id+"_course"+course_id+" tr.comp_"+competitor_id+"_dsq .gate").html();
      var status_id=$("#tab_summarytable table.run"+run_id+"_course"+course_id+" tr.comp_"+competitor_id+" div.status").attr("status_id");

      $("#form_txt_competitor").html(competitor_id);
      $("#form_txt_run").html(race_info.run_list[run_id].number);

      $("#form_run_id").val(run_id);
      $("#form_competitor_id").val(competitor_id);


      if($("#tab_summarytable table.run"+run_id+"_course"+course_id+" tr.comp_"+competitor_id).length){
        $("#form_status").val(status_id);
        $("#form_reason").val(reason);
        $("#form_gate").val(gate);
        $("#form_starttime").val(start_time);
        $("#form_finishtime").val(finish_time);
      }else{
        $("#form_status").val(1);
        $("#form_reason").val("");
        $("#form_gate").val("");
        $("#form_starttime").val("");
        $("#form_finishtime").val("");
      }
      $("#popup_editresult").modal('show');
    });
    $("body").on("click", ".btn_clear", function () {
      var run_id=$(this).attr('run_id');
      var competitor_id=$(this).attr('competitor_id');
      $.ajax({
        type: "GET",
        url: "/raceinfo/run/competitor/clear",
        data:({
          'run_id': run_id,
          'competitor_id': competitor_id
        }),
        success:function(data) {
          if(set_comp_status(competitor_id, "clear" ,run_id)){
            console.log('clear competitor - run:'+run_id+' competitor:'+competitor_id);
            $("#tab_manualcontrol tr.tr_"+run_id+"_"+competitor_id+" .status").html("cleared");
            $("#tab_manualcontrol tr.tr_"+run_id+"_"+competitor_id).removeClass("danger");
            $("#tab_manualcontrol tr.tr_"+run_id+"_"+competitor_id).removeClass("warning");
            $("#tab_manualcontrol tr.tr_"+run_id+"_"+competitor_id).removeClass("success");
            //$("#tab_manualcontrol .btn").prop('disabled',false);
            //$("#tab_manualcontrol .btn_finish").prop('disabled',true);

          }
          //glob_arr["run"+run_id]["comp_"+competitor_id]=null;
          socket_emit();
          refresh_status("run"+run_id,"comp_"+competitor_id);
          console.log("after socket.emit('get/results'...");

          //get_current_data(race_id).then(refresh_status(run_id,competitor_id));
      },
        error: function(error) {
          alert('error - CLEAR competitor run:'+run_id+' competitor:'+competitor_id);
        }
      });
    });
    $("body").on("click", "#btn_src_save", function () {
      var data=new Array();
      $(".src_select_bib").each(function(index, el){
        if(el.value!=""){
          data.push({"run_id":$(el).attr("run_id"), "data_in_id":$(el).attr("data_in_id"), "race_competitor_id":(el.value?el.value:null), "result_detail_id":($(el).attr("result_detail_id")?$(el).attr("result_detail_id"):null)});
        }
      });
      socket.emit('change/data_in/competitors', JSON.stringify(data));
      console.log("btn_src_save:");
      console.log(JSON.stringify(data));
    });
    $("body").on("click", ".btn_report", function () {
      console.log($(this).attr("name"));
      if($(this).attr("name")=="startlist")$("#form_reportfields").attr("action","/raceinfo/race/"+race_id+"/reports/orderlist");

      if($(this).attr("name")=="startlist1")$("#form_reportfields").attr("action","/raceinfo/race/"+race_id+"/reports/orderlist/1");
      if($(this).attr("name")=="startlist2")$("#form_reportfields").attr("action","/raceinfo/race/"+race_id+"/reports/orderlist/2");
      if($(this).attr("name")=="startlist3")$("#form_reportfields").attr("action","/raceinfo/race/"+race_id+"/reports/orderlist/3");

      if($(this).attr("name")=="results_C73C")$("#form_reportfields").attr("action","/raceinfo/race/"+race_id+"/reports/results");
      if($(this).attr("name")=="results_C73C_un")$("#form_reportfields").attr("action","/raceinfo/race/"+race_id+"/reports/results/unofficial");
      if($(this).attr("name")=="results_C73C_first")$("#form_reportfields").attr("action","/raceinfo/race/"+race_id+"/reports/results/first");

      console.log($("#form_reportfields").attr("action"));
      $("#form_reportfields").submit();
    });
    $("body").on("click", "#btn_setrace", function () {
      setCookie("race_id",$("#select_race").val());
      //console.log("setCookie(\"race_id\","+$("#select_race").val()+");");
      window.location.reload();
    });
    $("body").on("click", ".showhide_comp_results", function () {
      var val=this.value;
      var run=$(this).attr('run');
      var comp=$(this).attr('competitor');
      var fields=Array("absoluttime", "time", "rank", "diff", "sectortime", "sectorrank", "sectordiff", "speed", "thead");
      if(val=="+"){
        for(var i=0;i<fields.length;i++){
          $("#tab_summarytable .div_run"+run+" tbody tr.comp_"+comp+"_"+fields[i]).show();
        }
        this.value="-";
      }else{
        for(var i=0;i<fields.length;i++){
          $("#tab_summarytable .div_run"+run+" tbody tr.comp_"+comp+"_"+fields[i]).hide();
        }
        this.value="+";
      }
      $(this).children().toggleClass("glyphicon-chevron-down glyphicon-chevron-up");

    });

    $("body").on("click", ".btn_raceresults", function () {
      var data=new Array();
      $("#table_raceresults tbody").remove();
      $("#table_raceresults thead").remove();
      $("#table_raceresults").html("");
      $("#tab_raceresults_btn").html("");

      $.ajax({
        type: "GET",
        url: "/raceinfo/race/"+race_id+"/results",
        success:function(data1) {
          $.ajax({
            type: "GET",
            url: "/raceinfo/race/"+race_id+"/results/get",
            success:function(data) {
              var arr=JSON.parse(data);
              var run_cols1="";
              var run_cols2="";
              var rowspan;
              if(arr.length){
                $("#tab_raceresults_btn").append("<a href='/raceinfo/race/"+race_id+"/reports/xls' class='btn-primary btn'>Download xls</a><br>")

                $("#table_raceresults").append("<thead><tr class='headrow'><th rowspan=3>bib</th><th rowspan=3>Name</th><th rowspan=3>Rank</th><th rowspan=3>Time</th><th rowspan=3>Diff</th><th rowspan=3>Status</th></tr></thead>");
                $("#table_raceresults thead").append("<tr class='run_cols1'></tr>")
                $("#table_raceresults thead").append("<tr class='run_cols2'></tr>")
                for(var j=0;j<run_list.length;j++){
                  run_cols1 = run_cols1+"<td class='run"+run_list[j].id+"_rank'></td><td class='run"+run_list[j].id+"_time'></td><td class='run"+run_list[j].id+"_status'></td>";
                  run_cols2 = run_cols2+"<td class='run"+run_list[j].id+"_gate'></td><td class='run"+run_list[j].id+"_reason' colspan=2></td>";
                  $("#table_raceresults thead tr.headrow").append("<th colspan=3>Run "+run_list[j].number+"</th>");
                  $("#table_raceresults thead tr.run_cols1").append("<th>Rank</th><th>Time</th><th>Status</th>");
                  $("#table_raceresults thead tr.run_cols2").append("<th>gate</th><th colspan=2>reason</th>");
                }
                $("#table_raceresults").append("<tbody></tbody>");
                for(var i=0;i<arr.length;i++){
                  console.log("arr.length="+arr.length+" i="+i);
                  if(arr[i].status_id==1){rowspan=""; style_mistakes="success";}
                  else{rowspan=" rowspan='2' "; style_mistakes="danger";}
                  rowspan=" rowspan='2' ";
                  /*
                  var m=0;
                  while(!glob_arr["run"+run_list[m].number]["comp_"+arr[i].race_competitor_id] && m<run_list.length){
                      m++;
                      console.log(arr[i].race_competitor_id+"m="+m);
                  }
                  getObjById(run_list[0].start_list,"id",arr[i].results[k].status_id).name
                  run_id=run_list[m].number;
                  */
                  //console.log("run_id="+run_id);
                  var bib=arr[i].bib; //get info from server
                  var name=arr[i].en_firstname+" "+arr[i].en_lastname+" / "+arr[i].ru_firstname+" "+arr[i].ru_lastname;
                  $("#table_raceresults tbody").append("<tr class='comp_"+arr[i].race_competitor_id+" "+(arr[i].status_id==1?"success":"danger")+" row_competitor'><td"+rowspan+">"+bib+"</td><td"+rowspan+">"+name+"</td><td"+rowspan+">"+arr[i].global_rank+"</td><td"+rowspan+">"+tform(arr[i].result_time)+"</td><td"+rowspan+">"+tform(arr[i].diff)+"</td><td"+rowspan+">"+getObjById(status_list,"id",arr[i].status_id).name+"</td>"+run_cols1+"</tr>");
                  //if(arr[i].status_id!=1)
                    $("#table_raceresults tbody").append("<tr class='comp_"+arr[i].race_competitor_id+" "+style_mistakes+"'>"+run_cols2+"</tr>");
                  for(var k=0;k<arr[i].results.length;k++){
                    $("#table_raceresults tbody tr.comp_"+arr[i].race_competitor_id+" td.run"+arr[i].results[k].run_id+"_rank").html(arr[i].results[k].rank);
                    $("#table_raceresults tbody tr.comp_"+arr[i].race_competitor_id+" td.run"+arr[i].results[k].run_id+"_time").html(tform(arr[i].results[k].time));
                    $("#table_raceresults tbody tr.comp_"+arr[i].race_competitor_id+" td.run"+arr[i].results[k].run_id+"_status").html(getObjById(status_list,"id",arr[i].results[k].status_id).name);
                    //if(arr[i].status_id!=1){
                      $("#table_raceresults tbody tr.comp_"+arr[i].race_competitor_id+" td.run"+arr[i].results[k].run_id+"_gate").html(arr[i].results[k].gate);
                      $("#table_raceresults tbody tr.comp_"+arr[i].race_competitor_id+" td.run"+arr[i].results[k].run_id+"_reason").html(arr[i].results[k].reason);
                    //}
                  }
                }
              }
            },
            error: function(error){
              console.log('error - get results');
            }
          });
        },
        error: function(error) {
          console.log('error - recalculate results');
        }
      });
    });

/*
*   END // обработка кнопок
*/
});


    </script>
    {% endblock %}
